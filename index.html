<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>gen_java: easy java for erlang</title>
<!-- 2015-04-03 Fri 09:15 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Joe DeVivo" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://thomasf.github.io/solarized-css/solarized-light.min.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">gen_java: easy java for erlang</h1>
<div id="vid" style="position:fixed;top:100;z-index:1000" align="center" width="100%">
<iframe width="560" height="315" src="https://www.youtube.com/embed/llHWDdqeQnU" frameborder="0" allowfullscreen></iframe>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">_</h2>
<div class="outline-text-2" id="text-1">
<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Joe DeVivo |  <a href="http://twitter.com/joedevivo">@joedevivo</a> |  <a href="http://chef.io">CHEF</a></h3>
<div class="outline-text-3" id="text-1-1">
<p>
<a href="http://joedevivo.com/ef2015">http://joedevivo.com/ef2015</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Introduction</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>I write Erlang at CHEF
</li>
<li>I used to write Java
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Analytics at Chef</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">Stream processing of all data that flows through</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Chef Server.
</p>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">Used on clusters of up to 40,000 nodes!</h3>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">Sends alerts to various endpoints</h3>
<div class="outline-text-3" id="text-3-3">
<p>
when various things happen
</p>
<ul class="org-ul">
<li>Hipchat
</li>
<li>SMTP
</li>
<li>Webhooks
</li>
<li>More Coming Soon!
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Want more?</h2>
<div class="outline-text-2" id="text-4">
<p>
BUY MY CONFIGURATION MANAGEMENT INFRASTRUCTURE
</p>

<p>
<a href="http://chef.io">CHEF.io</a> | <a href="http://docs.chef.io/analytics/">Analytics Documentation</a>
</p>

<p>
COME TO CHEFCONF: 3/31 - 4/2 Santa Clara
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Alaska Pipeline</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">Apache Storm Pipeline</h3>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">It's a pipeline, Alaska has pipelines,</h3>
<div class="outline-text-3" id="text-5-2">
<p>
so we called it Alaska
</p>

<p>
You write rules <a href="http://docs.chef.io/analytics/analytics_rules.html">Rule Documentation</a>
</p>

<pre class="example">
rules 'PCI 2.3 â€“ Confirm telnet port not available'
 rule on run_control
  when
    name = 'telnet not listening' and
    resource_type = 'port' and
    resource_name = '23' and
    status != 'success'
  then
    audit:error("PCI 2.3 - Encrypt all non-console \
                 administrative access such as \
                 browser/Web-based management tools.")
    notify("security-team@financialcorp.com",
           "{{run.node_name}} is listening for \
           connections on port 23/telnet!")
  end
end
</pre>

<p>
notify(X) will use a different set of definitions
for what those messages contain.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Parsing Rules</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">Alaska Rules, an ANTLR grammar for Java</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Events processed by Apache Storm pipeline
</p>

<p>
Rule syntax based on a subset of Complex
Event Processing (CEP)
</p>

<p>
More info on that:
</p>

<ul class="org-ul">
<li><a href="http://blog.confluent.io/2015/01/29/making-sense-of-stream-processing/">CEP Blog Post</a>
</li>
<li><a href="http://www.espertech.com/esper/">Esper</a>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Configuration Web Service</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>Erlang
</li>

<li><a href="http://github.com/basho/webmachine">Webmachine</a>
    REST Framework
</li>

<li><a href="http://github.org/chef/sqerl">Sqerl</a>
    Lightweight ORM on top of epgsql
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">Validating Rules</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">Dave likes writing parsers, so he gave us</h3>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">Erlaska Rules</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><a href="https://github.com/seancribbs/neotoma">Neotoma</a> Parser</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Neotoma is a packrat parser-generator for Erlang for
Parsing Expression Grammars (PEGs).
</p>

<p>
The important thing being that it's different from
how ANTLR does grammars
</p>

<p>
erlaska_rules only ever validated syntax, whereas
alaska_rules is an actual compiler that generates
code to evaluate in the pipeline
</p>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">erlaska_rules.erl</h2>
<div class="outline-text-2" id="text-10">
<p>
erlaska_rules is a module generated by the neotoma
project. Once we have that parser, validating rules
from webmachine was as easy as:
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">inside malformed_request/2</span>
<span style="color: #718c00;">case</span> <span style="color: #4271ae;">erlaska_rules</span>:<span style="color: #4271ae;">parse</span>(<span style="color: #eab700;">Rule</span>) <span style="color: #718c00;">of</span>
    true -&gt;
        {false, <span style="color: #eab700;">Req</span>, <span style="color: #eab700;">State</span>#<span style="color: #4271ae;">state</span>{rule=<span style="color: #eab700;">Rule</span>}};
    {false, <span style="color: #eab700;">_Reason</span>} -&gt;
        {true, <span style="color: #eab700;">Req</span>, <span style="color: #eab700;">State</span>}
<span style="color: #718c00;">end</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">Problem?</h2>
<div class="outline-text-2" id="text-11">
<p>
This worked fine at first, but every change to the
grammar had to be duplicated. Well, it turns out
that we never got that far. We never actually achieved
100% compatibility.
</p>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12">What If?</h2>
<div class="outline-text-2" id="text-12">
<p>
We could call the Java parser from Erlang?
</p>

<p>
We've already got the ANTLR grammar, which is the
definitive truth for correctness of rules anyway.
If we could use that, we cut our work in half.
</p>

<p>
Even though Dave loves parsers.
</p>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13">The easy way</h2>
<div class="outline-text-2" id="text-13">
<p>
We could have just made a java command line tool
for parsing rules, but it just seemed like too
much of a hack
</p>
</div>
</div>

<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14">Wait</h2>
<div class="outline-text-2" id="text-14">
<p>
I've run Java from Erlang before with Riak_JMX.
If you have to do something twice, it's time
to make it generic.
</p>
</div>
</div>

<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15">Let's Do More</h2>
<div class="outline-text-2" id="text-15">
<p>
But actually, I'm doing something new here. What
I really want to do is send Java an rpc:call and
have Erlang not really even care that
Java is involved.
</p>
</div>
</div>

<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16">JInterface</h2>
<div class="outline-text-2" id="text-16">
<p>
It turns out we've had this for a while.
</p>
</div>

<div id="outline-container-sec-16-1" class="outline-3">
<h3 id="sec-16-1">It understands the ideas of:</h3>
<div class="outline-text-3" id="text-16-1">
<ul class="org-ul">
<li>Nodes
</li>
<li>EPMD
</li>
<li>Erlang Datatypes
</li>
<li>Process Messages
</li>
</ul>

<p>
<a href="http://www.erlang.org/doc/apps/jinterface/jinterface_users_guide.html">JInterface User Guide</a> | <a href="http://www.erlang.org/doc/apps/jinterface/java/com/ericsson/otp/erlang/package-summary.html">JInterface Javadoc</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17">No RPC, No Problem</h2>
<div class="outline-text-2" id="text-17">
<p>
Note: OTP source links will all be to the
      tag R16B03-1
</p>

<p>
I already knew that RPC calls were handled by a process
called `rex`, so I started digging around the Erlang
source for it
</p>

<p>
<a href="https://github.com/erlang/otp/blob/OTP_R16B03-1/lib/kernel/src/rpc.erl#L344">rpc.erl</a>
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">In the source for rpc.erl</span>
<span style="color: #8959a8;">-define</span>(<span style="color: #eab700;">NAME</span>, rex).
<span style="color: #f5871f;">do_call</span>(<span style="color: #eab700;">Node</span>, <span style="color: #eab700;">Request</span>, <span style="color: #eab700;">Timeout</span>) -&gt;
  <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">...</span>
  <span style="color: #eab700;">Result</span> = <span style="color: #4271ae;">gen_server</span>:<span style="color: #4271ae;">call</span>({?<span style="color: #4271ae;">NAME</span>,<span style="color: #eab700;">Node</span>}, <span style="color: #eab700;">Request</span>, <span style="color: #eab700;">Timeout</span>),
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18">So, what's `Request` look like?</h2>
<div class="outline-text-2" id="text-18">
<p>
It's coming in to rpc:do_call, so let's look at <a href="https://github.com/erlang/otp/blob/OTP_R16B03-1/lib/kernel/src/rpc.erl#L296">rpc:call</a>
which calls it.
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #f5871f;">call</span>(<span style="color: #eab700;">N</span>,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,infinity) <span style="color: #718c00;">when</span> <span style="color: #8959a8;">node</span>() ==:== <span style="color: #eab700;">N</span> -&gt;
    <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">Optimize local call</span>
    <span style="color: #4271ae;">local_call</span>(<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>);
<span style="color: #f5871f;">call</span>(<span style="color: #eab700;">N</span>,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,infinity) -&gt;
    <span style="color: #4271ae;">do_call</span>(<span style="color: #eab700;">N</span>,
           {call,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #8959a8;">group_leader</span>()},
           infinity);
<span style="color: #f5871f;">call</span>(<span style="color: #eab700;">N</span>,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #eab700;">Timeout</span>) <span style="color: #718c00;">when</span> <span style="color: #8959a8;">is_integer</span>(<span style="color: #eab700;">Timeout</span>),
                           <span style="color: #eab700;">Timeout</span> &gt;= 0 -&gt;
    <span style="color: #4271ae;">do_call</span>(<span style="color: #eab700;">N</span>,
            {call,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #8959a8;">group_leader</span>()},
            <span style="color: #eab700;">Timeout</span>).
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-19" class="outline-2">
<h2 id="sec-19">do_call</h2>
<div class="outline-text-2" id="text-19">
<ul class="org-ul">
<li>Some RPC magic we don't need to worry about
</li>
<li>what we do care about is that it calls gen_server:call
</li>
</ul>

<p>
<a href="https://github.com/erlang/otp/blob/OTP_R16B03-1/lib/kernel/src/rpc.erl#L334-L361">rpc:do_call</a>
</p>

<p>
There's some pretty nifty stuff in there about spawning
monitors and trapping exits, but it's not really relevant
to what we're doing here
</p>
</div>
</div>

<div id="outline-container-sec-20" class="outline-2">
<h2 id="sec-20">Request</h2>
<div class="outline-text-2" id="text-20">
<div class="org-src-container">

<pre class="src src-erlang">Request = {
  call        :: <span style="color: #8959a8;">atom</span>(),
  <span style="color: #eab700;">Module</span>      :: <span style="color: #8959a8;">atom</span>(),
  <span style="color: #eab700;">Function</span>    :: <span style="color: #8959a8;">atom</span>(),
  <span style="color: #eab700;">Arguments</span>   :: [<span style="color: #8959a8;">any</span>()],
  <span style="color: #eab700;">GroupLeader</span> :: <span style="color: #8959a8;">pid</span>()
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-21" class="outline-2">
<h2 id="sec-21">But wait, there's more</h2>
<div class="outline-text-2" id="text-21">
<p>
That's not all Erlang would be sending to another node.
Let's dig into the gen_server:call
</p>

<p>
<a href="https://github.com/erlang/otp/blob/OTP_R16B03-1/lib/stdlib/src/gen_server.erl#L168-L189">gen_server:call</a>
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #f5871f;">call</span>(<span style="color: #eab700;">Name</span>, <span style="color: #eab700;">Request</span>, <span style="color: #eab700;">Timeout</span>) -&gt;
    <span style="color: #718c00;">case</span> <span style="color: #718c00;">catch</span> <span style="color: #4271ae;">gen</span>:<span style="color: #4271ae;">call</span>(<span style="color: #eab700;">Name</span>, <span style="color: #3e999f;">'$gen_call'</span>,
                        <span style="color: #eab700;">Request</span>, <span style="color: #eab700;">Timeout</span>) <span style="color: #718c00;">of</span>
        {ok,<span style="color: #eab700;">Res</span>} -&gt;
            <span style="color: #eab700;">Res</span>;
        {<span style="color: #3e999f;">'EXIT'</span>,<span style="color: #eab700;">Reason</span>} -&gt;
            <span style="color: #8959a8;">exit</span>({<span style="color: #eab700;">Reason</span>,
                  {?<span style="color: #4271ae;">MODULE</span>, call, [<span style="color: #eab700;">Name</span>,
                                   <span style="color: #eab700;">Request</span>,
                                   <span style="color: #eab700;">Timeout</span>]}})
    <span style="color: #718c00;">end</span>.
</pre>
</div>

<p>
the rabbit hole goes deeper.
</p>

<p>
WARNING: rpc is in kernel, but gen_server is in stdlib
  if you're digging in source
</p>
</div>
</div>

<div id="outline-container-sec-22" class="outline-2">
<h2 id="sec-22">gen:call</h2>
<div class="outline-text-2" id="text-22">
<p>
Source: <a href="https://github.com/erlang/otp/blob/OTP_R16B03-1/lib/stdlib/src/gen.erl#L134-L243">gen:call</a>
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">deep in gen:do_call, which is called by gen:call</span>
<span style="color: #8959a8;">erlang</span>:<span style="color: #8959a8;">send</span>(<span style="color: #eab700;">Process</span>,
      {<span style="color: #eab700;">Label</span>, {<span style="color: #8959a8;">self</span>(), <span style="color: #eab700;">Mref</span>}, <span style="color: #eab700;">Request</span>}, <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">&lt;- THIS!</span>
      [noconnect])
</pre>
</div>

<p>
Jackpot! The second argument to erlang:send/3 is our message!
The actual message being sent is a 3-tuple
</p>
</div>
</div>

<div id="outline-container-sec-23" class="outline-2">
<h2 id="sec-23">So, here's the path</h2>
<div class="outline-text-2" id="text-23">
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(            <span style="color: #eab700;">Node</span>,                    <span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,    <span style="color: #eab700;">T</span>) -&gt;
<span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">do_call</span>(         <span style="color: #eab700;">Node</span>,              {call,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #eab700;">GL</span>},<span style="color: #eab700;">T</span>) -&gt;
<span style="color: #4271ae;">gen_server</span>:<span style="color: #4271ae;">call</span>({rex,<span style="color: #eab700;">Node</span>},             {call,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #eab700;">GL</span>},<span style="color: #eab700;">T</span>) -&gt;
<span style="color: #4271ae;">gen</span>:<span style="color: #4271ae;">call</span>(       {rex,<span style="color: #eab700;">Node</span>}, <span style="color: #3e999f;">'$gen_call'</span>,{call,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #eab700;">GL</span>},<span style="color: #eab700;">T</span>) -&gt;
<span style="color: #4271ae;">gen</span>:<span style="color: #4271ae;">do_call</span>(    {rex,<span style="color: #eab700;">Node</span>}, <span style="color: #3e999f;">'$gen_call'</span>,{call,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #eab700;">GL</span>},<span style="color: #eab700;">T</span>) -&gt;
<span style="color: #8959a8;">erlang</span>:<span style="color: #8959a8;">send</span>(    {rex,<span style="color: #eab700;">Node</span>},{<span style="color: #3e999f;">'$gen_call'</span>,
                                {<span style="color: #8959a8;">self</span>(), <span style="color: #eab700;">Mref</span>},
                                        {call,<span style="color: #eab700;">M</span>,<span style="color: #eab700;">F</span>,<span style="color: #eab700;">A</span>,<span style="color: #eab700;">GL</span>}).
<span style="color: #8e908c; font-style: italic;">%%% </span><span style="color: #8e908c; font-style: italic;">^^^ JACKPOT!</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-24" class="outline-2">
<h2 id="sec-24">1st element: ID</h2>
<div class="outline-text-2" id="text-24">
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #3e999f;">'$gen_call'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-25" class="outline-2">
<h2 id="sec-25">2nd element: Return Address</h2>
<div class="outline-text-2" id="text-25">
<div class="org-src-container">

<pre class="src src-erlang">{ <span style="color: #eab700;">From</span> :: <span style="color: #8959a8;">pid</span>(),
  <span style="color: #eab700;">MRef</span> :: <span style="color: #4271ae;">ref</span>() }
</pre>
</div>

<p>
From pid could be waiting for a bunch of replies.
MRef let's it know what it's a reply to
</p>
</div>
</div>

<div id="outline-container-sec-26" class="outline-2">
<h2 id="sec-26">3rd element: RPC Request</h2>
<div class="outline-text-2" id="text-26">
<p>
Request from above
</p>

<div class="org-src-container">

<pre class="src src-erlang">Request = {
  call        :: <span style="color: #8959a8;">atom</span>(),
  <span style="color: #eab700;">Module</span>      :: <span style="color: #8959a8;">atom</span>(),
  <span style="color: #eab700;">Function</span>    :: <span style="color: #8959a8;">atom</span>(),
  <span style="color: #eab700;">Arguments</span>   :: [<span style="color: #8959a8;">any</span>()],
  <span style="color: #eab700;">GroupLeader</span> :: <span style="color: #8959a8;">pid</span>()
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-27" class="outline-2">
<h2 id="sec-27">Now we know</h2>
<div class="outline-text-2" id="text-27">
<p>
what Erlang sends to other erlang nodes for rpc:call
</p>

<p>
Knowing is half the battle!
</p>
</div>
</div>

<div id="outline-container-sec-28" class="outline-2">
<h2 id="sec-28">Setting up the Java Side</h2>
<div class="outline-text-2" id="text-28">
<p>
JInterface gives us Node for free, so we can just
set something up to listen for messages
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">public</span> <span style="color: #718c00;">static</span> <span style="color: #4271ae;">void</span> <span style="color: #f5871f;">main</span>(<span style="color: #4271ae;">String</span>[] <span style="color: #eab700;">stringArgs</span>)
                                 <span style="color: #718c00;">throws</span> <span style="color: #4271ae;">Exception</span> {
    <span style="color: #4271ae;">String</span> <span style="color: #eab700;">nodename</span> = stringArgs[0];
    <span style="color: #4271ae;">String</span> <span style="color: #eab700;">cookie</span> = stringArgs[1];
    <span style="color: #4271ae;">OtpNode</span> <span style="color: #eab700;">self</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpNode</span>(nodename, cookie);
    <span style="color: #4271ae;">OtpMbox</span> <span style="color: #eab700;">rex</span> = self.createMbox(<span style="color: #3e999f;">"rex"</span>);
    <span style="color: #718c00;">while</span>(<span style="color: #4271ae;">true</span>) {
    <span style="color: #8e908c; font-style: italic;">// </span><span style="color: #8e908c; font-style: italic;">rex.receive is a blocking call,</span>
    <span style="color: #8e908c; font-style: italic;">// </span><span style="color: #8e908c; font-style: italic;">so just hang out here until one shows up</span>
        <span style="color: #4271ae;">OtpErlangObject</span> <span style="color: #eab700;">o</span> = rex.receive();
        System.out.println(<span style="color: #3e999f;">"Rex received '"</span>
                           + o.toString());
    }
}
</pre>
</div>

<p>
The Simplest of Java nodes. Just opens up a `rex`
mailbox and waits for messages. Any rpc:call to
this node will just print it's content to stdout.
</p>
</div>
</div>

<div id="outline-container-sec-29" class="outline-2">
<h2 id="sec-29">Deserialization in Java</h2>
<div class="outline-text-2" id="text-29">
<p>
This is where we start missing pattern matching.
It takes about 50 lines of Java to parse out that
3-tuple that gen:do_call is sending over. And
that's with Exception handling abstracted out
</p>

<p>
Source <a href="https://github.com/joedevivo/gen_java/blob/0.1.2/src/main/java/com/devivo/gen_java/ErlangRemoteProcedureCallMessage.java#L20-L77">ErlangRemoteProcedureCallMessage.java</a>
</p>
</div>
</div>

<div id="outline-container-sec-30" class="outline-2">
<h2 id="sec-30">Validate Arity</h2>
<div class="outline-text-2" id="text-30">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #4271ae;">OtpErlangTuple</span> <span style="color: #eab700;">rexCall</span> = (<span style="color: #4271ae;">OtpErlangTuple</span>)o;
<span style="color: #4271ae;">int</span> <span style="color: #eab700;">arity</span> = rexCall.arity();
<span style="color: #718c00;">if</span> (arity != 3) {
    <span style="color: #718c00;">throw</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">Exception</span>(
       <span style="color: #3e999f;">"Rex message has invalid arity. expected 3, got "</span>
       + arity);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-31" class="outline-2">
<h2 id="sec-31">Validate gen_call as first element:</h2>
<div class="outline-text-2" id="text-31">
<p>
Remember the 1st element? '$gen_call'
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #4271ae;">OtpErlangAtom</span> <span style="color: #eab700;">gen_call</span> =
         (<span style="color: #4271ae;">OtpErlangAtom</span>)(rexCall.elementAt(0));
<span style="color: #4271ae;">String</span> <span style="color: #eab700;">gen_call_string</span> = gen_call.atomValue();
<span style="color: #718c00;">if</span> (<span style="color: #4271ae;">!</span>gen_call_string.equals(<span style="color: #3e999f;">"$gen_call"</span>)) {
    <span style="color: #718c00;">throw</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">Exception</span>(
        <span style="color: #3e999f;">"Rex message should start with '$gen_call': "</span>
        + o.toString());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-32" class="outline-2">
<h2 id="sec-32">Validate second element: {Pid::pid, Ref::ref}</h2>
<div class="outline-text-2" id="text-32">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #4271ae;">OtpErlangTuple</span> <span style="color: #eab700;">fromTuple</span> =
         (<span style="color: #4271ae;">OtpErlangTuple</span>)(rexCall.elementAt(1));
<span style="color: #4271ae;">int</span> <span style="color: #eab700;">fromArity</span> = fromTuple.arity();
<span style="color: #718c00;">if</span> (fromArity != 2) {
    <span style="color: #718c00;">throw</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">Exception</span>(
        <span style="color: #3e999f;">"Rex message's 'from' tuple should have 2 elements, has "</span>
         + fromArity + <span style="color: #3e999f;">": "</span> + o.toString());
}
<span style="color: #718c00;">this</span>.fromPid = (<span style="color: #4271ae;">OtpErlangPid</span>)(fromTuple.elementAt(0));
<span style="color: #718c00;">this</span>.fromRef = (<span style="color: #4271ae;">OtpErlangRef</span>)(fromTuple.elementAt(1));
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-33" class="outline-2">
<h2 id="sec-33">Validate the call tuple:</h2>
<div class="outline-text-2" id="text-33">
<p>
{call::atom, Mod::atom, Fun::atom, List::list(), user:atom()}
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #4271ae;">OtpErlangTuple</span> <span style="color: #eab700;">callTuple</span> = (<span style="color: #4271ae;">OtpErlangTuple</span>)(rexCall.elementAt(2));
<span style="color: #4271ae;">int</span> <span style="color: #eab700;">callArity</span> = callTuple.arity();
<span style="color: #718c00;">if</span> (callArity != 5) {
    <span style="color: #718c00;">throw</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangRemoteException</span>(<span style="color: #718c00;">this</span>.fromPid, <span style="color: #718c00;">this</span>.fromRef,
         <span style="color: #3e999f;">"Rex message's 'call' tuple should have 5 elements, has "</span>
         + callArity + <span style="color: #3e999f;">": "</span> + o.toString());
}
<span style="color: #4271ae;">OtpErlangAtom</span> <span style="color: #eab700;">callAtom</span> = (<span style="color: #4271ae;">OtpErlangAtom</span>)(callTuple.elementAt(0));
<span style="color: #4271ae;">String</span> <span style="color: #eab700;">callString</span> = callAtom.atomValue();
<span style="color: #718c00;">if</span> (<span style="color: #4271ae;">!</span>callString.equals(<span style="color: #3e999f;">"call"</span>)) {
    <span style="color: #718c00;">throw</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangRemoteException</span>(<span style="color: #718c00;">this</span>.fromPid, <span style="color: #718c00;">this</span>.fromRef,
       <span style="color: #3e999f;">"Rex message's call block should start with 'call', but it's : "</span>
       + callString);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-34" class="outline-2">
<h2 id="sec-34">Validate M,F,A</h2>
<div class="outline-text-2" id="text-34">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">try</span> {
    <span style="color: #718c00;">this</span>.mfa = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangModFunArgs</span>(
        (<span style="color: #4271ae;">OtpErlangAtom</span>)(callTuple.elementAt(1)),
        (<span style="color: #4271ae;">OtpErlangAtom</span>)(callTuple.elementAt(2)),
        (<span style="color: #4271ae;">OtpErlangList</span>)(callTuple.elementAt(3)));
    <span style="color: #718c00;">this</span>.remoteGroupLeaderPid = (<span style="color: #4271ae;">OtpErlangPid</span>)(callTuple.elementAt(4));
} <span style="color: #718c00;">catch</span> (<span style="color: #4271ae;">Exception</span> <span style="color: #eab700;">e</span>) {
    <span style="color: #718c00;">throw</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangRemoteException</span>(<span style="color: #718c00;">this</span>.fromPid, <span style="color: #718c00;">this</span>.fromRef, e);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-35" class="outline-2">
<h2 id="sec-35">Exception Handling: toErlangException</h2>
<div class="outline-text-2" id="text-35">
<p>
Source: <a href="https://github.com/joedevivo/gen_java/blob/0.1.2/src/main/java/com/devivo/gen_java/ErlangRemoteException.java">ErlangRemoteException.java</a>
</p>

<p>
turns exceptions into {error, "Message"}
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">public</span> <span style="color: #718c00;">static</span> <span style="color: #4271ae;">OtpErlangObject</span> <span style="color: #f5871f;">toErlangException</span>(<span style="color: #4271ae;">Exception</span> <span style="color: #eab700;">e</span>) {
    <span style="color: #4271ae;">OtpErlangObject</span>[] <span style="color: #eab700;">elements</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangObject</span>[2];
    elements[0] = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangAtom</span>(<span style="color: #3e999f;">"error"</span>);
    elements[1] = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangString</span>(e.getMessage());
    <span style="color: #718c00;">return</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangTuple</span>(elements);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-36" class="outline-2">
<h2 id="sec-36">Exception Handling: send</h2>
<div class="outline-text-2" id="text-36">
<p>
send knows just enough about erlang/rex to send
an error message back to rpc:call
</p>

<p>
We forgot to look at that! Fortunately it's
here in <a href="https://github.com/erlang/otp/blob/OTP_R16B03-1/lib/stdlib/src/gen.erl#L211-L214">gen:do_call</a>
</p>

<p>
It's waiting for a
</p>
<div class="org-src-container">

<pre class="src src-erlang">{<span style="color: #4271ae;">ref</span>(), <span style="color: #eab700;">Reply</span>}
</pre>
</div>
<p>
So we send
</p>
<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">public</span> <span style="color: #4271ae;">void</span> <span style="color: #f5871f;">send</span>(<span style="color: #4271ae;">OtpMbox</span> <span style="color: #eab700;">mbox</span>) {
    <span style="color: #4271ae;">OtpErlangObject</span>[] <span style="color: #eab700;">elements</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangObject</span>[2];
    elements[0] = <span style="color: #718c00;">this</span>.fromRef;
    elements[1] = <span style="color: #718c00;">this</span>.toErlangException();
    mbox.send(<span style="color: #718c00;">this</span>.fromPid, <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangTuple</span>(elements));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-37" class="outline-2">
<h2 id="sec-37">But, sometimes not.</h2>
<div class="outline-text-2" id="text-37">
<p>
If you noticed, we don't start using ErlangRemoteException
until after we've read in the second tuple. It's not until
then that we know enough about the sender to know where to
send the reply. Before that, we just throw regular exceptions.
We'll catch both types when we process incoming messages.
If we don't know how to respond, we'll just dump the output
to the console, which we'll teach the erlang side to monitor.
</p>
</div>
</div>

<div id="outline-container-sec-38" class="outline-2">
<h2 id="sec-38">try/catch</h2>
<div class="outline-text-2" id="text-38">
<p>
<a href="https://github.com/joedevivo/gen_java/blob/0.1.2/src/main/java/com/devivo/gen_java/ErlangServer.java#L104-L125">Java incoming message processing</a>
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #4271ae;">ErlangRemoteProcedureCallMessage</span> <span style="color: #eab700;">msg</span> = <span style="color: #4271ae;">null</span>;
<span style="color: #718c00;">try</span> {
    msg = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangRemoteProcedureCallMessage</span>(rex, o);
} <span style="color: #718c00;">catch</span> (<span style="color: #4271ae;">ErlangRemoteException</span> <span style="color: #eab700;">erlE</span>) {
    erlE.send(rex);
} <span style="color: #718c00;">catch</span> (<span style="color: #4271ae;">Exception</span> <span style="color: #eab700;">e</span>) {
    System.out.println(<span style="color: #3e999f;">"Rex received '"</span>
        + o.toString()
        + <span style="color: #3e999f;">"' but didn't know how to process it. Exception: "</span>
        + e.getMessage());
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-39" class="outline-2">
<h2 id="sec-39">Back to the Erlang side</h2>
</div>

<div id="outline-container-sec-40" class="outline-2">
<h2 id="sec-40">The gen_java module</h2>
<div class="outline-text-2" id="text-40">
<ul class="org-ul">
<li>It's a gen_server
</li>
<li>Starts a jar of your choosing!
</li>
<li>When you build that jar, include gen_java.jar
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-41" class="outline-2">
<h2 id="sec-41">The gen_java project structure</h2>
<div class="outline-text-2" id="text-41">
<ul class="org-ul">
<li>src/main/java &lt;- maven will build a jar with this
</li>
<li>src/main/erlang &lt;- rebar will use this
</li>
</ul>


<div class="figure">
<p><img src="./img/mcdlt.jpg" alt="mcdlt.jpg" />
</p>
</div>

<p>
At least it's not McRib
</p>
</div>
</div>

<div id="outline-container-sec-42" class="outline-2">
<h2 id="sec-42">Starting the gen_java server</h2>
<div class="outline-text-2" id="text-42">
<ul class="org-ul">
<li>Opens a port running your jar in the JVM
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-43" class="outline-2">
<h2 id="sec-43">Basic Handshake</h2>
<div class="outline-text-2" id="text-43">
<div class="org-src-container">

<pre class="src src-erlang">Fetch = <span style="color: #718c00;">fun</span>() -&gt;
    <span style="color: #eab700;">X</span> = <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #eab700;">Nodename</span>, erlang, node, [], 10000),
    <span style="color: #eab700;">Nodename</span> = : = <span style="color: #eab700;">X</span>
<span style="color: #718c00;">end</span>,
<span style="color: #718c00;">case</span> <span style="color: #4271ae;">wait_until</span>(<span style="color: #eab700;">Fetch</span>, 20, 1000) <span style="color: #718c00;">of</span>
    ok -&gt;
        <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #eab700;">Nodename</span>, erlang, link, [<span style="color: #8959a8;">self</span>()]),
        <span style="color: #8959a8;">erlang</span>:<span style="color: #8959a8;">monitor_node</span>(<span style="color: #eab700;">Nodename</span>, true),
        <span style="color: #4271ae;">init_callback</span>( <span style="color: #eab700;">State</span>#<span style="color: #4271ae;">gen_java_state</span>{ port = <span style="color: #eab700;">Port</span>, pid = <span style="color: #eab700;">Pid</span>});
    timeout -&gt;
        {stop, timeout}
<span style="color: #718c00;">end</span>
</pre>
</div>


<div class="figure">
<p><img src="./img/Mean-Girls-stop-trying-to-make-fetch-happen.gif" alt="Mean-Girls-stop-trying-to-make-fetch-happen.gif" />
</p>
<p><span class="figure-number">Figure 2:</span> that's so fetch</p>
</div>
</div>
</div>

<div id="outline-container-sec-44" class="outline-2">
<h2 id="sec-44">Handshake: What just happened?</h2>
<div class="outline-text-2" id="text-44">
<ul class="org-ul">
<li>keeps rpc calling erlang:node/0 until it gets an answer
</li>
<li>if it doesn't stop the server, otherwise
</li>
<li>link the java node back to the server's process
</li>
<li>monitor the java node
</li>
<li>init_callback?
</li>
</ul>

<p>
After we've started, there's a callback that lets you run some
start up java code before we start accepting rpc:calls
</p>
</div>
</div>

<div id="outline-container-sec-45" class="outline-2">
<h2 id="sec-45">Error logging</h2>
<div class="outline-text-2" id="text-45">
<p>
<a href="https://github.com/joedevivo/gen_java/blob/master/src/main/erlang/gen_java.erl#L150-L152">handle_info/2</a>
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #f5871f;">handle_info</span>({<span style="color: #eab700;">Port</span>, {data, {<span style="color: #eab700;">_Type</span>, <span style="color: #eab700;">Data</span>}}},
            #<span style="color: #4271ae;">gen_java_state</span> {port = <span style="color: #eab700;">Port</span>,
                             module = <span style="color: #eab700;">M</span> } = <span style="color: #eab700;">State</span>) -&gt;
    <span style="color: #4271ae;">lager</span>:<span style="color: #4271ae;">info</span>(<span style="color: #3e999f;">"[gen_java][~p] ~s"</span>, [<span style="color: #eab700;">M</span>, <span style="color: #eab700;">Data</span>]),
    {noreply, <span style="color: #eab700;">State</span>};
</pre>
</div>

<p>
Now that we've got a port running this JVM anything that java
System.out.printlns will end up in your erlang application's log
</p>
</div>
</div>

<div id="outline-container-sec-46" class="outline-2">
<h2 id="sec-46">Recap</h2>
<div class="outline-text-2" id="text-46">
</div><div id="outline-container-sec-46-1" class="outline-3">
<h3 id="sec-46-1">We're sending rpc:calls to the java node</h3>
</div>
<div id="outline-container-sec-46-2" class="outline-3">
<h3 id="sec-46-2">we can send error messages back</h3>
<div class="outline-text-3" id="text-46-2">
<ul class="org-ul">
<li>console
</li>
<li>rpc responses
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-47" class="outline-2">
<h2 id="sec-47">So, what do we do with actual rpc calls?</h2>
</div>

<div id="outline-container-sec-48" class="outline-2">
<h2 id="sec-48">The Easy Way : Hard Coded</h2>
<div class="outline-text-2" id="text-48">
<p>
There are somethings we just want every java node to be able to do:
</p>
</div>

<div id="outline-container-sec-48-1" class="outline-3">
<h3 id="sec-48-1">Needed by our Handshake</h3>
<div class="outline-text-3" id="text-48-1">
<ul class="org-ul">
<li>erlang:node/0
</li>
<li>erlang:link/1
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-48-2" class="outline-3">
<h3 id="sec-48-2">POC Methods</h3>
<div class="outline-text-3" id="text-48-2">
<ul class="org-ul">
<li>erlang:abs/1 x2
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-48-3" class="outline-3">
<h3 id="sec-48-3">Nice for JVM inspection</h3>
<div class="outline-text-3" id="text-48-3">
<ul class="org-ul">
<li>java:system_properties/0
</li>
<li>java:system_env/0
</li>
<li>java:input_args/0
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-49" class="outline-2">
<h2 id="sec-49">WTF is the java module?!</h2>
<div class="outline-text-2" id="text-49">
<p>
I made it up. I made the erlang module up too.
Java doesn't have these
</p>

<p>
Let's talk about how we map erlang MFAs
</p>
</div>
</div>

<div id="outline-container-sec-50" class="outline-2">
<h2 id="sec-50">All Others</h2>
<div class="outline-text-2" id="text-50">
<ul class="org-ul">
<li>must be java methods of type public static final
</li>

<li>must have all arguments and return types of classes
provided by JInterface
</li>

<li>since java reflection is a bit expensive, we cache the
Method objects.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-51" class="outline-2">
<h2 id="sec-51">Initializing the RPC Method Cache</h2>
<div class="outline-text-2" id="text-51">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #4271ae;">Map</span>&lt;<span style="color: #4271ae;">ErlangFunctionCacheKey</span>, <span style="color: #4271ae;">Method</span>&gt; <span style="color: #eab700;">RPCCache</span> =
    <span style="color: #718c00;">new</span> <span style="color: #4271ae;">HashMap</span>&lt;<span style="color: #4271ae;">ErlangFunctionCacheKey</span>, <span style="color: #4271ae;">Method</span>&gt;();
RPCCache.put(
        <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangFunctionCacheKey</span>(
                <span style="color: #3e999f;">"erlang"</span>, <span style="color: #3e999f;">"abs"</span>, OtpErlangDouble.<span style="color: #718c00;">class</span>),
        Erlang.<span style="color: #718c00;">class</span>.getMethod(<span style="color: #3e999f;">"abs"</span>, OtpErlangDouble.<span style="color: #718c00;">class</span>));
RPCCache.put(
        <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangFunctionCacheKey</span>(
                <span style="color: #3e999f;">"erlang"</span>, <span style="color: #3e999f;">"abs"</span>, OtpErlangLong.<span style="color: #718c00;">class</span>),
        Erlang.<span style="color: #718c00;">class</span>.getMethod(<span style="color: #3e999f;">"abs"</span>, OtpErlangLong.<span style="color: #718c00;">class</span>));
</pre>
</div>

<p>
last arg is variable list of classes
</p>

<p>
<a href="https://github.com/joedevivo/gen_java/blob/master/src/main/java/com/devivo/gen_java/Erlang.java">Erlang.java</a>
</p>
</div>
</div>

<div id="outline-container-sec-52" class="outline-2">
<h2 id="sec-52">dat java module</h2>
<div class="outline-text-2" id="text-52">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #8e908c; font-style: italic;">// </span><span style="color: #8e908c; font-style: italic;">wrapper for java.util.System.getProperties()</span>
RPCCache.put(
        <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangFunctionCacheKey</span>(<span style="color: #3e999f;">"java"</span>, <span style="color: #3e999f;">"system_properties"</span>),
        Java.<span style="color: #718c00;">class</span>.getMethod(<span style="color: #3e999f;">"system_properties"</span>));

RPCCache.put(
        <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangFunctionCacheKey</span>(<span style="color: #3e999f;">"java"</span>, <span style="color: #3e999f;">"system_env"</span>),
        Java.<span style="color: #718c00;">class</span>.getMethod(<span style="color: #3e999f;">"system_env"</span>));

RPCCache.put(
        <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ErlangFunctionCacheKey</span>(<span style="color: #3e999f;">"java"</span>, <span style="color: #3e999f;">"input_arguments"</span>),
        Java.<span style="color: #718c00;">class</span>.getMethod(<span style="color: #3e999f;">"input_arguments"</span>));
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-53" class="outline-2">
<h2 id="sec-53">ACHEIVEMENT UNLOCKED: Java dot java</h2>
<div class="outline-text-2" id="text-53">
<p>
<a href="https://github.com/joedevivo/gen_java/blob/master/src/main/java/com/devivo/gen_java/Java.java">Java.java</a>
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">public</span> <span style="color: #718c00;">static</span> <span style="color: #4271ae;">OtpErlangList</span> <span style="color: #f5871f;">system_properties</span>() {
    <span style="color: #4271ae;">List</span>&lt;<span style="color: #4271ae;">OtpErlangTuple</span>&gt; <span style="color: #eab700;">l</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">ArrayList</span>&lt;<span style="color: #4271ae;">OtpErlangTuple</span>&gt;();
    <span style="color: #4271ae;">Iterator</span>&lt;<span style="color: #4271ae;">Map</span>.<span style="color: #4271ae;">Entry</span>&lt;<span style="color: #4271ae;">Object</span>, <span style="color: #4271ae;">Object</span>&gt;&gt; <span style="color: #eab700;">it</span> =
        System.getProperties().entrySet().iterator();
    <span style="color: #718c00;">while</span>(it.hasNext()) {
        <span style="color: #4271ae;">Map</span>.<span style="color: #4271ae;">Entry</span>&lt;<span style="color: #4271ae;">Object</span>, <span style="color: #4271ae;">Object</span>&gt; <span style="color: #eab700;">i</span> = it.next();
        <span style="color: #4271ae;">OtpErlangObject</span>[] <span style="color: #eab700;">elems</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangObject</span>[2];
        elems[0] = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangAtom</span>(i.getKey().toString());
        elems[1] = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangBinary</span>(
                         i.getValue().toString().getBytes());
        <span style="color: #4271ae;">OtpErlangTuple</span> <span style="color: #eab700;">t</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangTuple</span>(elems);
        l.add(t);
    }
    <span style="color: #718c00;">return</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangList</span>(l.toArray(<span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangObject</span>[0]));
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-54" class="outline-2">
<h2 id="sec-54">java:system_properties()</h2>
<div class="outline-text-2" id="text-54">
<div class="org-src-container">

<pre class="src src-erlang">(erlang@127.0.0.1)1&gt; <span style="color: #4271ae;">net_adm</span>:<span style="color: #4271ae;">ping</span>(<span style="color: #3e999f;">'java@127.0.0.1'</span>).
pong
(erlang@127.0.0.1)2&gt; <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'java@127.0.0.1'</span>, java, system_properties, []).
[{<span style="color: #3e999f;">'java.runtime.name'</span>,&lt;&lt;<span style="color: #3e999f;">"Java(TM) SE Runtime Environment"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.boot.library.path'</span>,&lt;&lt;<span style="color: #3e999f;">"/Library/Java/JavaVirtualMachines/jdk1.7.0_71.jdk/Contents/Home/jre/lib"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vm.version'</span>,&lt;&lt;<span style="color: #3e999f;">"24.71-b01"</span>&gt;&gt;},
 {gopherProxySet,&lt;&lt;<span style="color: #3e999f;">"false"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vm.vendor'</span>,&lt;&lt;<span style="color: #3e999f;">"Oracle Corporation"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vendor.url'</span>,&lt;&lt;<span style="color: #3e999f;">"http://java.oracle.com/"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'path.separator'</span>,&lt;&lt;<span style="color: #3e999f;">":"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vm.name'</span>,&lt;&lt;<span style="color: #3e999f;">"Java HotSpot(TM) 64-Bit Server VM"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'file.encoding.pkg'</span>,&lt;&lt;<span style="color: #3e999f;">"sun.io"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'user.country'</span>,&lt;&lt;<span style="color: #3e999f;">"US"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.java.launcher'</span>,&lt;&lt;<span style="color: #3e999f;">"SUN_STANDARD"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.os.patch.level'</span>,&lt;&lt;<span style="color: #3e999f;">"unknown"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vm.specification.name'</span>,&lt;&lt;<span style="color: #3e999f;">"Java Virtual Machine Specification"</span>&gt;&gt;},
  {<span style="color: #3e999f;">'java.runtime.version'</span>,&lt;&lt;<span style="color: #3e999f;">"1.7.0_71-b14"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.awt.graphicsenv'</span>,&lt;&lt;<span style="color: #3e999f;">"sun.awt.CGraphicsEnvironment"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.endorsed.dirs'</span>,&lt;&lt;<span style="color: #3e999f;">"/Library/Java/JavaVirtualMachines/jdk1.7.0_71.jdk/Contents/Home/jre/lib/endorsed"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'os.arch'</span>,&lt;&lt;<span style="color: #3e999f;">"x86_64"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.io.tmpdir'</span>,&lt;&lt;<span style="color: #3e999f;">"/var/folders/hl/zf_j1bvs7_b18rj7bbsm35p00000gp/T/"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'line.separator'</span>,&lt;&lt;<span style="color: #3e999f;">"\n"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vm.specification.vendor'</span>,&lt;&lt;<span style="color: #3e999f;">"Oracle Corporation"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'os.name'</span>,&lt;&lt;<span style="color: #3e999f;">"Mac OS X"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.jnu.encoding'</span>,&lt;&lt;<span style="color: #3e999f;">"UTF-8"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.library.path'</span>,&lt;&lt;<span style="color: #3e999f;">"/System/Library/Java/Extensions:/usr/lib/java:."</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.specification.name'</span>,&lt;&lt;<span style="color: #3e999f;">"Java Platform API Specification"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.class.version'</span>,&lt;&lt;<span style="color: #3e999f;">"51.0"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.management.compiler'</span>,&lt;&lt;<span style="color: #3e999f;">"HotSpot 64-Bit Tiered Compilers"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'os.version'</span>,&lt;&lt;<span style="color: #3e999f;">"10.10.2"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'http.nonProxyHosts'</span>,&lt;&lt;<span style="color: #3e999f;">"local|*.local|169.254/16|*.169.254/16"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'user.timezone'</span>,&lt;&lt;&gt;&gt;},
 {<span style="color: #3e999f;">'java.awt.printerjob'</span>,&lt;&lt;<span style="color: #3e999f;">"sun.lwawt.macosx.CPrinterJob"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'file.encoding'</span>,&lt;&lt;<span style="color: #3e999f;">"UTF-8"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.specification.version'</span>,&lt;&lt;<span style="color: #3e999f;">"1.7"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.class.path'</span>,&lt;&lt;<span style="color: #3e999f;">"target/gen_java-0.1.2-SNAPSHOT-jar-with-dependencies.jar"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vm.specification.version'</span>,&lt;&lt;<span style="color: #3e999f;">"1.7"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.java.command'</span>,&lt;&lt;<span style="color: #3e999f;">"com.devivo.gen_java.ErlangServer java@127.0.0.1 cookie 10"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.home'</span>,&lt;&lt;<span style="color: #3e999f;">"/Library/Java/JavaVirtualMachines/jdk1.7.0_71.jdk/Contents/Home/jre"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.arch.data.model'</span>,&lt;&lt;<span style="color: #3e999f;">"64"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'user.language'</span>,&lt;&lt;<span style="color: #3e999f;">"en"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.specification.vendor'</span>,&lt;&lt;<span style="color: #3e999f;">"Oracle Corporation"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'awt.toolkit'</span>,&lt;&lt;<span style="color: #3e999f;">"sun.lwawt.macosx.LWCToolkit"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vm.info'</span>,&lt;&lt;<span style="color: #3e999f;">"mixed mode"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.version'</span>,&lt;&lt;<span style="color: #3e999f;">"1.7.0_71"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vendor'</span>,&lt;&lt;<span style="color: #3e999f;">"Oracle Corporation"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'file.separator'</span>,&lt;&lt;<span style="color: #3e999f;">"/"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'java.vendor.url.bug'</span>,&lt;&lt;<span style="color: #3e999f;">"http://bugreport.sun.com/bugreport/"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.io.unicode.encoding'</span>,&lt;&lt;<span style="color: #3e999f;">"UnicodeBig"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.cpu.endian'</span>,&lt;&lt;<span style="color: #3e999f;">"little"</span>&gt;&gt;},
 {socksNonProxyHosts,&lt;&lt;<span style="color: #3e999f;">"local|*.local|169.254/16|*.169.254/16"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'ftp.nonProxyHosts'</span>,&lt;&lt;<span style="color: #3e999f;">"local|*.local|169.254/16|*.169.254/16"</span>&gt;&gt;},
 {<span style="color: #3e999f;">'sun.cpu.isalist'</span>,&lt;&lt;&gt;&gt;}]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-55" class="outline-2">
<h2 id="sec-55">What about your own methods?</h2>
<div class="outline-text-2" id="text-55">
</div><div id="outline-container-sec-55-1" class="outline-3">
<h3 id="sec-55-1">Module: Full Java Class Name</h3>
</div>
<div id="outline-container-sec-55-2" class="outline-3">
<h3 id="sec-55-2">Function: Java Method Name</h3>
</div>
<div id="outline-container-sec-55-3" class="outline-3">
<h3 id="sec-55-3">Args: ARGS!</h3>
</div>
</div>

<div id="outline-container-sec-56" class="outline-2">
<h2 id="sec-56">Caching?</h2>
<div class="outline-text-2" id="text-56">
<p>
<a href="https://github.com/joedevivo/gen_java/blob/0.1.2/src/main/java/com/devivo/gen_java/ErlangServer.java#L145-L165">check the cache</a>
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">if</span>(RPCCache.containsKey(msg.getMFA().getKey())) {
    <span style="color: #4271ae;">Method</span> <span style="color: #eab700;">m</span> = RPCCache.get(msg.getMFA().getKey());
    msg.setMethod(m);
    pool.execute(msg);
} <span style="color: #718c00;">else</span> {
    <span style="color: #8e908c; font-style: italic;">//// </span><span style="color: #8e908c; font-style: italic;">This means it's not in the cache, we should</span>
    <span style="color: #8e908c; font-style: italic;">//// </span><span style="color: #8e908c; font-style: italic;">try and find it and add it.</span>
    <span style="color: #4271ae;">Method</span> <span style="color: #eab700;">m</span> = find(msg.getMFA().getKey());
    <span style="color: #718c00;">if</span> (m != <span style="color: #4271ae;">null</span>) {
        RPCCache.put(msg.getMFA().getKey(), m);
        msg.setMethod(m);
        pool.execute(msg);
    } <span style="color: #718c00;">else</span> {
        System.out.println(<span style="color: #3e999f;">"Bad RPC: "</span> +
            msg.getMFA().getKey().toString());
        <span style="color: #8e908c; font-style: italic;">//// </span><span style="color: #8e908c; font-style: italic;">we couldn't add it, be nice and send a badrpc error back</span>
        msg.send(msg.toErlangBadRPC());
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-57" class="outline-2">
<h2 id="sec-57">msg.toErlangBadRPC()</h2>
<div class="outline-text-2" id="text-57">
<p>
<a href="https://github.com/joedevivo/gen_java/blob/master/src/main/java/com/devivo/gen_java/ErlangRemoteProcedureCallMessage.java#L94-L139">toErlangBadRPC()</a>
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8e908c; font-style: italic;">% </span><span style="color: #8e908c; font-style: italic;">Bad RPC calls look like this:</span>
{badrpc,{<span style="color: #3e999f;">'EXIT'</span>,{undef,[{<span style="color: #eab700;">Module</span>,<span style="color: #eab700;">Fun</span>,[],[]},
                {rpc,<span style="color: #3e999f;">'-handle_call_call/6-fun-0-'</span>,5,
                     [{file,<span style="color: #3e999f;">"rpc.erl"</span>},{line,205}]}]}}}
</pre>
</div>

<p>
So we construct that tuple as a repsonse and send it
</p>
</div>
</div>

<div id="outline-container-sec-58" class="outline-2">
<h2 id="sec-58">Caching Payoff!</h2>
<div class="outline-text-2" id="text-58">
<p>
Reflection is only done once per method.
</p>
</div>
</div>

<div id="outline-container-sec-59" class="outline-2">
<h2 id="sec-59">We're aiming for the pool, right?</h2>
<div class="outline-text-2" id="text-59">
<div class="org-src-container">

<pre class="src src-java">pool.execute(msg);
</pre>
</div>
<p>
We went ahead and added some thread pooling on the java side.
</p>

<p>
Otherwise all the processing happening in once place.
what if you asked it to do hard things?
</p>

<p>
<a href="https://github.com/joedevivo/gen_java/blob/master/src/main/java/com/devivo/gen_java/ErlangRemoteProcedureCallMessage.java#L146-L157">pool.execute()</a> is where we package up the method's
return value and send it back to Erlang.
</p>

<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">public</span> <span style="color: #4271ae;">void</span> <span style="color: #f5871f;">run</span>() {
    <span style="color: #4271ae;">OtpErlangObject</span> <span style="color: #eab700;">result</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangAtom</span>(<span style="color: #3e999f;">"null"</span>);
    <span style="color: #718c00;">try</span> {
        result = (<span style="color: #4271ae;">OtpErlangObject</span>)
            <span style="color: #718c00;">this</span>.method.invoke(<span style="color: #4271ae;">null</span>, getMFA().getArgs().elements());
    } <span style="color: #718c00;">catch</span> (<span style="color: #4271ae;">Exception</span> <span style="color: #eab700;">e</span>) {
        <span style="color: #8e908c; font-style: italic;">//// </span><span style="color: #8e908c; font-style: italic;">This could "technically" throw a InvocationTargetException</span>
        <span style="color: #8e908c; font-style: italic;">//// </span><span style="color: #8e908c; font-style: italic;">or an IllegalAccessException. We'll write defensive code</span>
        <span style="color: #8e908c; font-style: italic;">//// </span><span style="color: #8e908c; font-style: italic;">for that eventually</span>
        System.out.println(e.getClass().getName() + <span style="color: #3e999f;">" : "</span> + e.getMessage());
        result = error(e.getClass().getName() + <span style="color: #3e999f;">" : "</span> + e.getMessage());
    }
    <span style="color: #718c00;">this</span>.send(result);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-60" class="outline-2">
<h2 id="sec-60">Wrapping Responses</h2>
<div class="outline-text-2" id="text-60">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">public</span> <span style="color: #4271ae;">void</span> <span style="color: #f5871f;">send</span>(<span style="color: #4271ae;">OtpErlangObject</span> <span style="color: #eab700;">resp</span>) {
    <span style="color: #718c00;">this</span>.rex.send(<span style="color: #718c00;">this</span>.fromPid, wrapResponse(resp));
}

<span style="color: #718c00;">public</span> <span style="color: #4271ae;">OtpErlangTuple</span> <span style="color: #f5871f;">wrapResponse</span>(<span style="color: #4271ae;">OtpErlangObject</span> <span style="color: #eab700;">resp</span>) {
    <span style="color: #4271ae;">OtpErlangObject</span>[] <span style="color: #eab700;">elements</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangObject</span>[2];
    elements[0] = <span style="color: #718c00;">this</span>.fromRef;
    elements[1] = resp;
    <span style="color: #718c00;">return</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangTuple</span>(elements);
}
</pre>
</div>

<p>
this.send makes sure to send it to the right place
</p>

<p>
wrapResponse makes sure to include that ref() we need for RPC
</p>
</div>
</div>

<div id="outline-container-sec-61" class="outline-2">
<h2 id="sec-61">Erlang Developer Experience</h2>
<div class="outline-text-2" id="text-61">
<p>
You might remember that I'm kind of a user experience nut
</p>

<p>
<a href="http://github.com/basho/cuttlefish">Cuttlefish</a>
</p>
</div>
</div>

<div id="outline-container-sec-62" class="outline-2">
<h2 id="sec-62">Your Java Module</h2>
<div class="outline-text-2" id="text-62">
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8959a8;">-module</span>(my_java).

<span style="color: #8959a8;">-compile</span>({parse_transform, gen_java_parse_transform}).
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-63" class="outline-2">
<h2 id="sec-63">Your sys.config</h2>
<div class="outline-text-2" id="text-63">
<div class="org-src-container">

<pre class="src src-erlang">[{gen_java, [
     {modules, [
         {my_java, [
             {jar, <span style="color: #3e999f;">"/path/to/my.jar"</span>},
             {thread_count, 10}
                        ]}
               ]}
            ]}
].
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-64" class="outline-2">
<h2 id="sec-64">Your Supervisor</h2>
<div class="outline-text-2" id="text-64">
</div><div id="outline-container-sec-64-1" class="outline-3">
<h3 id="sec-64-1">start it with my_java:start_link/0 or</h3>
<div class="outline-text-3" id="text-64-1">
<div class="org-src-container">

<pre class="src src-erlang">{my_java,
    {my_java, start_link, []},
    permanent, 5000, worker, [my_java]},
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-65" class="outline-2">
<h2 id="sec-65">start_link/0?!  Parse Transform</h2>
<div class="outline-text-2" id="text-65">
</div><div id="outline-container-sec-65-1" class="outline-3">
<h3 id="sec-65-1">wrappers for gen_java functions</h3>
<div class="outline-text-3" id="text-65-1">
<div class="org-src-container">

<pre class="src src-erlang">17 = <span style="color: #4271ae;">my_java</span>:<span style="color: #4271ae;">call</span>(erlang, abs, [-17]).
&lt;&lt;<span style="color: #3e999f;">"your heart's desire"</span>&gt;&gt; =
     <span style="color: #4271ae;">my_java</span>:<span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'com.my.package'</span>,<span style="color: #3e999f;">'myMethod'</span>,[]).
</pre>
</div>

<p>
<a href="https://github.com/joedevivo/gen_java/blob/master/src/main/erlang/gen_java_parse_transform.erl">gen_java_parse_transform.erl</a>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-66" class="outline-2">
<h2 id="sec-66">5 Functions for FREE</h2>
<div class="outline-text-2" id="text-66">
<p>
This whole file just looks for a module's name,
and subs it in to 5 functions
</p>
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8959a8;">-export</span>([<span style="color: #4271ae;">start_link/0</span>,<span style="color: #4271ae;">start/0</span>,<span style="color: #4271ae;">call/3</span>,<span style="color: #4271ae;">call/4</span>,<span style="color: #4271ae;">stop/0</span>]).

<span style="color: #f5871f;">stop</span>() -&gt;
    <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">stop</span>(my_java).

<span style="color: #f5871f;">call</span>(<span style="color: #eab700;">Module</span>, <span style="color: #eab700;">Function</span>, <span style="color: #eab700;">Args</span>, <span style="color: #eab700;">Timeout</span>) -&gt;
    <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">call</span>(my_java, <span style="color: #eab700;">Module</span>, <span style="color: #eab700;">Function</span>, <span style="color: #eab700;">Args</span>, <span style="color: #eab700;">Timeout</span>).

<span style="color: #f5871f;">call</span>(<span style="color: #eab700;">Module</span>, <span style="color: #eab700;">Function</span>, <span style="color: #eab700;">Args</span>) -&gt;
    <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">call</span>(my_java, <span style="color: #eab700;">Module</span>, <span style="color: #eab700;">Function</span>, <span style="color: #eab700;">Args</span>).

<span style="color: #f5871f;">start</span>() -&gt;
    <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">start</span>(my_java).

<span style="color: #f5871f;">start_link</span>() -&gt;
    <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">start_link</span>(my_java).
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-67" class="outline-2">
<h2 id="sec-67">init callback</h2>
<div class="outline-text-2" id="text-67">
<p>
Remember that? put it here, it'll get called right after the handshake
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8959a8;">-spec</span> <span style="color: #4271ae;">init</span>(<span style="color: #8959a8;">atom</span>()) -&gt;<span style="color: #f5871f;"> </span>ok.
<span style="color: #f5871f;">init</span>(<span style="color: #eab700;">Nodename</span>) -&gt;
    <span style="color: #eab700;">SomeState</span> = {some, thing, maybe_a_file_path},
    <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #eab700;">Nodename</span>,
             <span style="color: #3e999f;">'com.yourcompany.package'</span>,
             <span style="color: #3e999f;">'init'</span>, [<span style="color: #eab700;">SomeState</span>]).
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-68" class="outline-2">
<h2 id="sec-68">Adding convenience</h2>
<div class="outline-text-2" id="text-68">
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8959a8;">-spec</span> <span style="color: #4271ae;">my_method</span>(<span style="color: #8959a8;">binary</span>()) -&gt;<span style="color: #f5871f;"> </span><span style="color: #8959a8;">binary</span>() | <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">badrpc</span>().
<span style="color: #f5871f;">my_method</span>(<span style="color: #eab700;">Binary</span>) -&gt;
    <span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'com.my.package'</span>,<span style="color: #3e999f;">'myMethod'</span>,[<span style="color: #eab700;">Binary</span>]).
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-69" class="outline-2">
<h2 id="sec-69">Then using java in your app is as easy as</h2>
<div class="outline-text-2" id="text-69">
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #4271ae;">my_java</span>:<span style="color: #4271ae;">my_method</span>(<span style="color: #eab700;">Binary</span>).
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-70" class="outline-2">
<h2 id="sec-70">Bringing it Back to CHEF Analytics</h2>
<div class="outline-text-2" id="text-70">
</div><div id="outline-container-sec-70-1" class="outline-3">
<h3 id="sec-70-1">erlaska_rules is out!</h3>
</div>

<div id="outline-container-sec-70-2" class="outline-3">
<h3 id="sec-70-2">alaska_rules.jar is in!</h3>
</div>
</div>

<div id="outline-container-sec-71" class="outline-2">
<h2 id="sec-71">sys.config</h2>
<div class="outline-text-2" id="text-71">
<div class="org-src-container">

<pre class="src src-erlang">[{gen_java, [
     {modules, [
         {alaska_rules, [
             {jar, <span style="color: #3e999f;">"priv/alaska_rules.jar"</span>},
             {thread_count, 10}
                        ]}
               ]}
            ]}
].
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-72" class="outline-2">
<h2 id="sec-72">alaska_rules.erl</h2>
<div class="outline-text-2" id="text-72">
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #8959a8;">-module</span>(alaska_rules).

<span style="color: #8959a8;">-compile</span>({parse_transform, gen_java_parse_transform}).

<span style="color: #8959a8;">-export</span>([<span style="color: #4271ae;">valid_rule/1</span>, <span style="color: #4271ae;">valid_rule_group/1</span>, <span style="color: #4271ae;">init/1</span>]).

<span style="color: #8959a8;">-spec</span> <span style="color: #4271ae;">valid_rule</span>(<span style="color: #8959a8;">binary</span>()) -&gt;
    true | {error, <span style="color: #8959a8;">string</span>()} | <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">badrpc</span>().
<span style="color: #f5871f;">valid_rule</span>(<span style="color: #eab700;">Bin</span>) -&gt;
    <span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'com.chef.analytics.rules.erlang.RuleValidator'</span>,
         <span style="color: #3e999f;">'validRule'</span>, [<span style="color: #eab700;">Bin</span>]).

<span style="color: #8959a8;">-spec</span> <span style="color: #4271ae;">valid_rule_group</span>(<span style="color: #8959a8;">binary</span>()) -&gt;
    true | {error, <span style="color: #8959a8;">string</span>()} | <span style="color: #4271ae;">gen_java</span>:<span style="color: #4271ae;">badrpc</span>().
<span style="color: #f5871f;">valid_rule_group</span>(<span style="color: #eab700;">Bin</span>) -&gt;
    <span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'com.chef.analytics.rules.erlang.RuleValidator'</span>,
    <span style="color: #3e999f;">'validRuleGroup'</span>, [<span style="color: #eab700;">Bin</span>]).
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-73" class="outline-2">
<h2 id="sec-73">What do those java methods look like?</h2>
<div class="outline-text-2" id="text-73">
<div class="org-src-container">

<pre class="src src-java"><span style="color: #718c00;">public</span> <span style="color: #718c00;">static</span> <span style="color: #4271ae;">OtpErlangObject</span> <span style="color: #f5871f;">validRule</span>(<span style="color: #4271ae;">OtpErlangBinary</span> <span style="color: #eab700;">ruleBin</span>) {
    <span style="color: #718c00;">try</span> {
        <span style="color: #4271ae;">String</span> <span style="color: #eab700;">ruleText</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">String</span>(ruleBin.binaryValue());
        <span style="color: #4271ae;">Rule</span> <span style="color: #eab700;">r</span> = compiler.compile(ruleText);
        <span style="color: #718c00;">return</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangAtom</span>(<span style="color: #4271ae;">true</span>);
    } <span style="color: #718c00;">catch</span> (<span style="color: #4271ae;">Exception</span> <span style="color: #eab700;">e</span>) {
        <span style="color: #718c00;">return</span> ErlangRemoteException.toErlangException(e);
    }
}

<span style="color: #718c00;">public</span> <span style="color: #718c00;">static</span> <span style="color: #4271ae;">OtpErlangObject</span> <span style="color: #f5871f;">validRuleGroup</span>(<span style="color: #4271ae;">OtpErlangBinary</span> <span style="color: #eab700;">ruleGrpBin</span>) {
    <span style="color: #718c00;">try</span> {
        <span style="color: #4271ae;">String</span> <span style="color: #eab700;">ruleGrpText</span> = <span style="color: #718c00;">new</span> <span style="color: #4271ae;">String</span>(ruleGrpBin.binaryValue());
        <span style="color: #4271ae;">RuleGroup</span> <span style="color: #eab700;">rg</span> = compiler.compileGroup(ruleGrpText);
        <span style="color: #718c00;">return</span> <span style="color: #718c00;">new</span> <span style="color: #4271ae;">OtpErlangAtom</span>(<span style="color: #4271ae;">true</span>);
    } <span style="color: #718c00;">catch</span> (<span style="color: #4271ae;">Exception</span> <span style="color: #eab700;">e</span>) {
        <span style="color: #718c00;">return</span> ErlangRemoteException.toErlangException(e);
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-74" class="outline-2">
<h2 id="sec-74">init/1</h2>
<div class="outline-text-2" id="text-74">
<p>
We have some JSON schemas that alaksa_rules.jar uses for
validation of attributes.
</p>

<p>
init/1 reads them in as a list of binaries and then sends
them over to the java node
</p>

<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #f5871f;">init</span>(<span style="color: #eab700;">Nodename</span>) -&gt;
    <span style="color: #eab700;">Dir</span> = <span style="color: #4271ae;">schema_dir</span>(),
    <span style="color: #eab700;">JSONSchemas</span> = <span style="color: #4271ae;">filelib</span>:<span style="color: #4271ae;">wildcard</span>(<span style="color: #4271ae;">filename</span>:<span style="color: #4271ae;">join</span>([<span style="color: #eab700;">Dir</span>, <span style="color: #3e999f;">"*.json"</span>])),
    <span style="color: #eab700;">Schemas</span> = [<span style="color: #718c00;">begin</span>
                   {ok, <span style="color: #eab700;">Bin</span>} = <span style="color: #4271ae;">file</span>:<span style="color: #4271ae;">read_file</span>(<span style="color: #eab700;">Filename</span>),
                   {<span style="color: #8959a8;">list_to_atom</span>(<span style="color: #4271ae;">filename</span>:<span style="color: #4271ae;">basename</span>(<span style="color: #eab700;">Filename</span>)), <span style="color: #eab700;">Bin</span>}
               <span style="color: #718c00;">end</span> <span style="color: #718c00;">||</span> <span style="color: #eab700;">Filename</span> <span style="color: #718c00;">&lt;-</span> <span style="color: #eab700;">JSONSchemas</span>],
    <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #eab700;">Nodename</span>,
             <span style="color: #3e999f;">'com.chef.analytics.rules.erlang.RuleValidator'</span>,
             <span style="color: #3e999f;">'setSchemas'</span>, [<span style="color: #eab700;">Schemas</span>]),
    ok.
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-75" class="outline-2">
<h2 id="sec-75">Bringing it back to WebMachine</h2>
<div class="outline-text-2" id="text-75">
<div class="org-src-container">

<pre class="src src-erlang"><span style="color: #718c00;">case</span> <span style="color: #4271ae;">alaska_rules</span>:<span style="color: #4271ae;">valid_rule_group</span>(
             <span style="color: #4271ae;">nc_obj_rule</span>:<span style="color: #4271ae;">getval</span>(rule, <span style="color: #eab700;">Rule</span>)) <span style="color: #718c00;">of</span>
    true -&gt;
        <span style="color: #4271ae;">lager</span>:<span style="color: #4271ae;">debug</span>(<span style="color: #3e999f;">"malformed_request: rule syntax good"</span>),
        {false, <span style="color: #eab700;">Req</span>, <span style="color: #eab700;">State</span>};
    {error, <span style="color: #eab700;">Msg</span>} -&gt;
        <span style="color: #4271ae;">lager</span>:<span style="color: #4271ae;">debug</span>(<span style="color: #3e999f;">"Invalid rule syntax: ~s"</span>, [<span style="color: #eab700;">Msg</span>]),
        <span style="color: #4271ae;">mf_return</span>(<span style="color: #eab700;">Msg</span>, [], <span style="color: #eab700;">Req</span>, <span style="color: #eab700;">State</span>);
    {badrpc, nodedown} -&gt;
        <span style="color: #4271ae;">lager</span>:<span style="color: #8959a8;">error</span>(<span style="color: #3e999f;">"Alaska Rules node down, no validation possible"</span>),
        <span style="color: #eab700;">NewReq</span> = <span style="color: #4271ae;">req_helper</span>([
            {set_resp_header, [<span style="color: #3e999f;">"content-type"</span>, <span style="color: #3e999f;">"application/json"</span>]},
            {set_resp_body, [<span style="color: #4271ae;">jiffy</span>:<span style="color: #4271ae;">encode</span>(
                {[{error, &lt;&lt;<span style="color: #3e999f;">"server side validation error"</span>&gt;&gt;}]})]}
        ], <span style="color: #eab700;">Req</span>),
        {{halt, 500}, <span style="color: #eab700;">NewReq</span>, <span style="color: #eab700;">State</span>}
<span style="color: #718c00;">end</span>.
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-76" class="outline-2">
<h2 id="sec-76">Wrapping Up</h2>
<div class="outline-text-2" id="text-76">
<p>
All in all, this is just a wrapper for the hard stuff
Erlang gave us for free. But what if they didn't?
</p>
</div>
</div>

<div id="outline-container-sec-77" class="outline-2">
<h2 id="sec-77">Erlang Haskell Interface</h2>
<div class="outline-text-2" id="text-77">

<div class="figure">
<p><img src="./img/haskell.png" alt="haskell.png" />
</p>
</div>

<p>
Introducing Erlang Haskell Interface 0.2
<a href="https://github.com/joedevivo/erlang-haskell-interface">github source</a>
</p>
</div>
</div>

<div id="outline-container-sec-78" class="outline-2">
<h2 id="sec-78">Erlang gives you zero Haskell for free</h2>
<div class="outline-text-2" id="text-78">
<p>
But somebody did: <a href="http://hackage.haskell.org/package/erlang-0.1">hackage erlang-0.1</a>
</p>
</div>
</div>

<div id="outline-container-sec-79" class="outline-2">
<h2 id="sec-79">What I got:</h2>
</div>

<div id="outline-container-sec-80" class="outline-2">
<h2 id="sec-80">Erlang Types in Haskell</h2>
<div class="outline-text-2" id="text-80">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #718c00;">data</span> <span style="color: #4271ae;">ErlType</span> <span style="color: #eab700;">=</span> <span style="color: #4271ae;">ErlNull</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlInt</span> <span style="color: #4271ae;">Int</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlBigInt</span> <span style="color: #4271ae;">Integer</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlString</span> <span style="color: #4271ae;">String</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlAtom</span> <span style="color: #4271ae;">String</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlBinary</span> [<span style="color: #4271ae;">Word8</span>]
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlList</span> [<span style="color: #4271ae;">ErlType</span>]
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlTuple</span> [<span style="color: #4271ae;">ErlType</span>]
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlPid</span> <span style="color: #4271ae;">ErlType</span> <span style="color: #4271ae;">Int</span> <span style="color: #4271ae;">Int</span> <span style="color: #4271ae;">Int</span>     <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">node id serial creation</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlPort</span> <span style="color: #4271ae;">ErlType</span> <span style="color: #4271ae;">Int</span> <span style="color: #4271ae;">Int</span>        <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">node id creation</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlRef</span> <span style="color: #4271ae;">ErlType</span> <span style="color: #4271ae;">Int</span> <span style="color: #4271ae;">Int</span>         <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">node id creation</span>
             <span style="color: #eab700;">|</span> <span style="color: #4271ae;">ErlNewRef</span> <span style="color: #4271ae;">ErlType</span> <span style="color: #4271ae;">Int</span> [<span style="color: #4271ae;">Word8</span>]  <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">node creation id</span>
             <span style="color: #718c00;">deriving</span> (<span style="color: #4271ae;">Eq</span>, <span style="color: #4271ae;">Show</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-81" class="outline-2">
<h2 id="sec-81">Packing functions</h2>
<div class="outline-text-2" id="text-81">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">putC</span> <span style="color: #eab700;">=</span> putWord8 <span style="color: #eab700;">.</span> fromIntegral
<span style="color: #f5871f;">putn</span> <span style="color: #eab700;">=</span> putWord16be <span style="color: #eab700;">.</span> fromIntegral
<span style="color: #f5871f;">putN</span> <span style="color: #eab700;">=</span> putWord32be <span style="color: #eab700;">.</span> fromIntegral
<span style="color: #f5871f;">puta</span> <span style="color: #eab700;">=</span> putByteString <span style="color: #eab700;">.</span> <span style="color: #4d4d4c; background-color: #ffffff;">B.pack</span>
<span style="color: #f5871f;">putA</span> <span style="color: #eab700;">=</span> putByteString <span style="color: #eab700;">.</span> <span style="color: #4d4d4c; background-color: #ffffff;">C.pack</span>

<span style="color: #f5871f;">getC</span> <span style="color: #eab700;">=</span> liftM fromIntegral getWord8
<span style="color: #f5871f;">getn</span> <span style="color: #eab700;">=</span> liftM fromIntegral getWord16be
<span style="color: #f5871f;">getN</span> <span style="color: #eab700;">=</span> liftM fromIntegral getWord32be
<span style="color: #f5871f;">geta</span> <span style="color: #eab700;">=</span> liftM <span style="color: #4d4d4c; background-color: #ffffff;">B.unpack</span> <span style="color: #eab700;">.</span> getByteString
<span style="color: #f5871f;">getA</span> <span style="color: #eab700;">=</span> liftM <span style="color: #4d4d4c; background-color: #ffffff;">C.unpack</span> <span style="color: #eab700;">.</span> getByteString
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-82" class="outline-2">
<h2 id="sec-82">Half a Protocol</h2>
<div class="outline-text-2" id="text-82">
<p>
Looks like erlang-0.1 knew how to connect to
an Erlang node from Haskell
</p>

<p>
It wanted it one way, but I wanted the other
</p>
</div>
</div>

<div id="outline-container-sec-83" class="outline-2">
<h2 id="sec-83">Getting the old one working</h2>
<div class="outline-text-2" id="text-83">
<p>
nano-md5 dependency didn't work anymore,
so replaced with PureMD5
</p>

<p>
<a href="https://wiki.haskell.org/Applications_and_libraries/Interfacing_other_languages/Erlang">Existing Documentation</a> wasn't great,
but it might have been me
</p>
</div>
</div>

<div id="outline-container-sec-84" class="outline-2">
<h2 id="sec-84">Spinning up an Erlang node in Haskell</h2>
<div class="outline-text-2" id="text-84">
<p>
<a href="https://github.com/joedevivo/erlang-haskell-interface/blob/master/Test.hs#L17-L30">start</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">start</span> nodename <span style="color: #eab700;">=</span> <span style="color: #718c00;">do</span>
    setupLoggers <span style="color: #4271ae;">DEBUG</span>
    infoM <span style="color: #3e999f;">"Test"</span> <span style="color: #eab700;">$</span> <span style="color: #3e999f;">"Starting Node: "</span> <span style="color: #eab700;">++</span> nodename
    self <span style="color: #eab700;">&lt;-</span> createSelf nodename
    mbox <span style="color: #eab700;">&lt;-</span> createMBox self
    debugM <span style="color: #3e999f;">"Test"</span> <span style="color: #eab700;">$</span> <span style="color: #3e999f;">"mbox: "</span> <span style="color: #eab700;">++</span> (show mbox)
    forever <span style="color: #eab700;">$</span> <span style="color: #718c00;">do</span>
    rex_mbox <span style="color: #eab700;">&lt;-</span> createNamedMBox <span style="color: #3e999f;">"rex"</span> self
    forkIO <span style="color: #eab700;">$</span> rex nodename rex_mbox
    return <span style="color: #4271ae;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-85" class="outline-2">
<h2 id="sec-85">createSelf: Creating the Haskell Node</h2>
<div class="outline-text-2" id="text-85">
<p>
<a href="https://github.com/joedevivo/erlang-haskell-interface/blob/master/src/Foreign/Erlang/Processes.hs#L66-L79">Processes.hs</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">createSelf</span>          <span style="color: #eab700;">::</span> <span style="color: #4271ae;">String</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">IO</span> <span style="color: #4271ae;">Self</span>
<span style="color: #f5871f;">createSelf</span> nodename <span style="color: #eab700;">=</span> <span style="color: #718c00;">do</span>
    inbox <span style="color: #eab700;">&lt;-</span> newEmptyMVar
    forkIO <span style="color: #eab700;">$</span> serve nodename inbox
    forkIO <span style="color: #eab700;">$</span> self nodename inbox
    node <span style="color: #eab700;">&lt;-</span> return <span style="color: #eab700;">.</span>  <span style="color: #4271ae;">Self</span> <span style="color: #eab700;">$</span> putMVar inbox
    nk_mbox <span style="color: #eab700;">&lt;-</span> createNamedMBox <span style="color: #3e999f;">"net_kernel"</span> node
    forkIO <span style="color: #eab700;">$</span> net_kernel nk_mbox
    return node
</pre>
</div>

<p>
self is the thing that routes those messages
</p>
</div>
</div>

<div id="outline-container-sec-86" class="outline-2">
<h2 id="sec-86">serve</h2>
<div class="outline-text-2" id="text-86">
<p>
serve is the function that connects to epmd, opens up a listener
and then puts messages in a mbox
</p>
</div>
</div>

<div id="outline-container-sec-87" class="outline-2">
<h2 id="sec-87">Learning EPMD</h2>
<div class="outline-text-2" id="text-87">
<p>
<a href="http://www.erlang.org/doc/man/epmd.html">epmd</a>
<a href="http://www.erlang.org/doc/apps/erts/erl_dist_protocol.html">protocol documentation</a>
</p>
</div>
</div>

<div id="outline-container-sec-88" class="outline-2">
<h2 id="sec-88">Reserving a port</h2>
<div class="outline-text-2" id="text-88">
<p>
EMPD_ALIVE2_REQ
</p>

<p>
Open a socked with this request and keep it open&#x2026; forever.
</p>

<p>
Here's the message EPMD expects
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="right" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">Bytes</th>
<th scope="col" class="left">Content</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">1</td>
<td class="left">120</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Port to reserve</td>
</tr>

<tr>
<td class="right">1</td>
<td class="left">77 (means normal erlang node)</td>
</tr>

<tr>
<td class="right">1</td>
<td class="left">Protocol (0 = tcp/ipv4)</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Highest version (5 = R6B and higher)</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Lowest version (5 = R6B and higher)</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Length in bytes of nodename field</td>
</tr>

<tr>
<td class="right">X</td>
<td class="left">Nodename, X = ^^</td>
</tr>

<tr>
<td class="right">2</td>
<td class="left">Length of Extras, we used 0</td>
</tr>

<tr>
<td class="right">Y</td>
<td class="left">Extras, length ^^, but we sent none</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-89" class="outline-2">
<h2 id="sec-89">What's that look like?</h2>
<div class="outline-text-2" id="text-89">

<div class="figure">
<p><img src="./img/EPMD_ALIVE2_REQ.png" alt="EPMD_ALIVE2_REQ.png" />
</p>
<p><span class="figure-number">Figure 4:</span> Wiretap of ALIVE2_REQ</p>
</div>


<div class="figure">
<p><img src="./img/EPMD_ALIVE2_RESP.png" alt="EPMD_ALIVE2_RESP.png" />
</p>
<p><span class="figure-number">Figure 5:</span> Bytes of ALIVE2_RESP</p>
</div>
</div>
</div>

<div id="outline-container-sec-90" class="outline-2">
<h2 id="sec-90">Haskell sends a EPMD_ALIVE2_REQ</h2>
<div class="outline-text-2" id="text-90">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">epmdAlive2Req</span> <span style="color: #eab700;">::</span> <span style="color: #4271ae;">String</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">Int</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">IO</span> <span style="color: #4271ae;">()</span>
<span style="color: #f5871f;">epmdAlive2Req</span> node port <span style="color: #eab700;">=</span> withEpmd <span style="color: #eab700;">$</span> <span style="color: #eab700;">\</span>hdl <span style="color: #eab700;">-&gt;</span> <span style="color: #718c00;">do</span>
    <span style="color: #718c00;">let</span> msg <span style="color: #eab700;">=</span> runPut <span style="color: #eab700;">$</span> tag <span style="color: #3e999f;">'x'</span> <span style="color: #eab700;">&gt;&gt;</span>
                       putn port <span style="color: #eab700;">&gt;&gt;</span>
                       putC 77 <span style="color: #eab700;">&gt;&gt;</span> <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">node type</span>
                       putC 0 <span style="color: #eab700;">&gt;&gt;</span>  <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">protocol</span>
                       putn erlangVersion <span style="color: #eab700;">&gt;&gt;</span>
                       putn erlangVersion <span style="color: #eab700;">&gt;&gt;</span>
                       putn (length node) <span style="color: #eab700;">&gt;&gt;</span>
                       putA node <span style="color: #eab700;">&gt;&gt;</span>
                       putn 0 <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">"Extra" length, 0 for none</span>
    <span style="color: #718c00;">let</span> len <span style="color: #eab700;">=</span> fromIntegral <span style="color: #eab700;">$</span> <span style="color: #4d4d4c; background-color: #ffffff;">B.length</span> msg
    <span style="color: #718c00;">let</span> out <span style="color: #eab700;">=</span> runPut <span style="color: #eab700;">$</span> putn len <span style="color: #eab700;">&gt;&gt;</span> putLazyByteString msg
    forever <span style="color: #eab700;">$</span> <span style="color: #718c00;">do</span>
    <span style="color: #4d4d4c; background-color: #ffffff;">B.hPut</span> hdl out
    hFlush hdl
    <span style="color: #4d4d4c; background-color: #ffffff;">B.hGetContents</span> hdl
    return <span style="color: #4271ae;">()</span>
</pre>
</div>

<p>
See that forever call. just hang out letting EPMD know you still love it.
</p>

<p>
TIL: You can run `empd -debug` to see what's coming across the wire through EPMD
</p>
</div>
</div>

<div id="outline-container-sec-91" class="outline-2">
<h2 id="sec-91">The Distribution Handshake</h2>
<div class="outline-text-2" id="text-91">
<p>
<a href="http://www.erlang.org/doc/apps/erts/erl_dist_protocol.html#id92374">Handshake Documentation</a>
</p>

<p>
ALIVE2_REQ isn't even a quarter of the handshake.
</p>

<p>
We also have to do a back and forth over the port we're actually listening on
</p>

<pre class="example">
send_name            ------&gt;            recv_name

recv_status          &lt;------          send_status

send_status          ------&gt;          recv_status

recv_challenge       &lt;------       send_challenge

send_challenge_reply ------&gt; recv_challenge_reply

recv_challege_ack    &lt;------   send_challenge_ack
</pre>


<div class="figure">
<p><img src="./img/SEND_NAME.png" alt="SEND_NAME.png" />
</p>
<p><span class="figure-number">Figure 6:</span> Here's an example of SEND_NAME</p>
</div>

<p>
Let's gloss over this. If you want to see it, I did it here: <a href="https://github.com/joedevivo/erlang-haskell-interface/blob/master/src/Foreign/Erlang/Network.hs#L197-L248">Network.hs</a>
</p>
</div>
</div>

<div id="outline-container-sec-92" class="outline-2">
<h2 id="sec-92">the serve function: listening for erlang communication</h2>
<div class="outline-text-2" id="text-92">
</div><div id="outline-container-sec-92-1" class="outline-3">
<h3 id="sec-92-1">Opens a socket on port X</h3>
</div>
<div id="outline-container-sec-92-2" class="outline-3">
<h3 id="sec-92-2">Does the ALIVE2_REQ with port X to EPMD</h3>
</div>
<div id="outline-container-sec-92-3" class="outline-3">
<h3 id="sec-92-3">Does the Distributed Erlang Handshake with the ErlNode</h3>
</div>
<div id="outline-container-sec-92-4" class="outline-3">
<h3 id="sec-92-4">Opens up two way communication erl &lt;-&gt; hs</h3>
</div>
<div id="outline-container-sec-92-5" class="outline-3">
<h3 id="sec-92-5">Routes any received messages to self via ErlDispatch</h3>
<div class="outline-text-3" id="text-92-5">
<p>
<a href="https://github.com/joedevivo/erlang-haskell-interface/blob/master/src/Foreign/Erlang/Processes.hs#L284-L335">serve</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">serve</span> <span style="color: #eab700;">::</span> <span style="color: #4271ae;">String</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">MVar</span> <span style="color: #4271ae;">ErlMessage</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">IO</span> <span style="color: #4271ae;">()</span>
<span style="color: #f5871f;">serve</span> nodename outbox <span style="color: #eab700;">=</span> <span style="color: #4d4d4c; background-color: #ffffff;">S.withSocketsDo</span> <span style="color: #eab700;">$</span>
    <span style="color: #718c00;">do</span>
        sock <span style="color: #eab700;">&lt;-</span> <span style="color: #4d4d4c; background-color: #ffffff;">S.socket</span> (<span style="color: #4d4d4c; background-color: #ffffff;">S.addrFamily</span> serveraddr) <span style="color: #4271ae;">S.Stream</span> <span style="color: #4d4d4c; background-color: #ffffff;">S.defaultProtocol</span>
        <span style="color: #4d4d4c; background-color: #ffffff;">S.bindSocket</span> sock (<span style="color: #4d4d4c; background-color: #ffffff;">S.addrAddress</span> serveraddr)
        port <span style="color: #eab700;">&lt;-</span> <span style="color: #4d4d4c; background-color: #ffffff;">S.socketPort</span> sock
        forkIO <span style="color: #eab700;">$</span> epmdAlive2Req nodename <span style="color: #eab700;">$</span> read <span style="color: #eab700;">$</span> show port
        <span style="color: #4d4d4c; background-color: #ffffff;">S.listen</span> sock 5
         <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">Create a lock to use for synchronizing access to the handler</span>
        lock <span style="color: #eab700;">&lt;-</span> newMVar <span style="color: #4271ae;">()</span>
        <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">Loop forever waiting for connections.  Ctrl-C to abort.</span>
        procRequests lock sock
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-93" class="outline-2">
<h2 id="sec-93">procRequests: processing incoming socket connections from Erlang</h2>
<div class="outline-text-2" id="text-93">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">procRequests</span> <span style="color: #eab700;">::</span> <span style="color: #4271ae;">MVar</span> <span style="color: #4271ae;">()</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">S.Socket</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">IO</span> <span style="color: #4271ae;">()</span>
<span style="color: #f5871f;">procRequests</span> lock mastersock <span style="color: #eab700;">=</span>
    <span style="color: #718c00;">do</span> (connsock, clientaddr) <span style="color: #eab700;">&lt;-</span> <span style="color: #4d4d4c; background-color: #ffffff;">S.accept</span> mastersock
       handleLog lock clientaddr <span style="color: #eab700;">$</span>
          <span style="color: #4d4d4c; background-color: #ffffff;">B.pack</span> <span style="color: #3e999f;">"Foreign.Erlang.Server: client connnected"</span>
       forkIO <span style="color: #eab700;">$</span> procMessages lock connsock clientaddr
       procRequests lock mastersock
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-94" class="outline-2">
<h2 id="sec-94">procMessages: processing messages from that socket</h2>
<div class="outline-text-2" id="text-94">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">procMessages</span> <span style="color: #eab700;">::</span> <span style="color: #4271ae;">MVar</span> <span style="color: #4271ae;">()</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">S.Socket</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">S.SockAddr</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">IO</span> <span style="color: #4271ae;">()</span>
<span style="color: #f5871f;">procMessages</span> lock connsock clientaddr <span style="color: #eab700;">=</span>
    <span style="color: #718c00;">do</span> connhdl <span style="color: #eab700;">&lt;-</span> <span style="color: #4d4d4c; background-color: #ffffff;">S.socketToHandle</span> connsock <span style="color: #4271ae;">ReadWriteMode</span>
       hSetBuffering connhdl <span style="color: #4271ae;">NoBuffering</span>
       (to, send, recv) <span style="color: #eab700;">&lt;-</span> erlConnectS connhdl nodename
       mvar <span style="color: #eab700;">&lt;-</span> newEmptyMVar
       forkIO <span style="color: #eab700;">$</span> nodeSend mvar send
       forkIO <span style="color: #eab700;">$</span> nodeRecv mvar recv outbox
       <span style="color: #718c00;">let</span> node <span style="color: #eab700;">=</span> putMVar mvar
       putMVar outbox <span style="color: #eab700;">$</span> <span style="color: #4271ae;">ConnectedNode</span> to node
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-95" class="outline-2">
<h2 id="sec-95">nodeRecv: routing incoming messages</h2>
<div class="outline-text-2" id="text-95">
<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #8e908c; font-style: italic;">{-</span>
<span style="color: #8e908c; font-style: italic;">A `nodeRecv` thread is responsible for communication from an Erlang</span>
<span style="color: #8e908c; font-style: italic;">process.  It receives messages from the network and dispatches them as</span>
<span style="color: #8e908c; font-style: italic;">appropriate.</span>
<span style="color: #8e908c; font-style: italic;">-}</span>
<span style="color: #f5871f;">nodeRecv</span> mvar recv outbox <span style="color: #eab700;">=</span> loop
  <span style="color: #718c00;">where</span>
    loop <span style="color: #eab700;">=</span> <span style="color: #718c00;">do</span>
        (mctl, mmsg) <span style="color: #eab700;">&lt;-</span> recv
        <span style="color: #718c00;">case</span> mctl <span style="color: #718c00;">of</span>
            <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">Nothing is a keepalive.  All we want to do is echo it.</span>
            <span style="color: #4271ae;">Nothing</span>  <span style="color: #eab700;">-&gt;</span> putMVar mvar (<span style="color: #4271ae;">Nothing</span>, <span style="color: #4271ae;">Nothing</span>)
            <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">A real message goes to self to be dispatched.</span>
            <span style="color: #4271ae;">Just</span> ctl <span style="color: #eab700;">-&gt;</span> putMVar outbox <span style="color: #eab700;">$</span>
                <span style="color: #4271ae;">ErlDispatch</span> ctl (fromJust mmsg)
        loop
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-96" class="outline-2">
<h2 id="sec-96">Funky Middle Syntax</h2>
<div class="outline-text-2" id="text-96">
<p>
<a href="http://www.erlang.org/doc/apps/erts/erl_dist_protocol.html#id92768">Protocol between connected nodes</a>
</p>

<p>
Turns out we need to figure out how to interpret Erlangy
packets coming in now
</p>

<p>
Here's the distilled version of what they could be:
</p>

<div class="org-src-container">

<pre class="src src-erlang">{1, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToPid</span>}                       <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">LINK</span>
{2, <span style="color: #eab700;">Cookie</span>, <span style="color: #eab700;">ToPid</span>}                        <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">SEND</span>
{3, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToPid</span>, <span style="color: #eab700;">Reason</span>}               <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">EXIT</span>
{4, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToPid</span>}                       <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">UNLINK</span>
{5}                                       <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">NODE_LINK</span>
{6, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">Cookie</span>, <span style="color: #eab700;">ToName</span>}              <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">REG_SEND</span>
{7, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToPid</span>}                       <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">GROUP_LEADER</span>
{8, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToPid</span>, <span style="color: #eab700;">Reason</span>}               <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">EXIT2</span>
{12, <span style="color: #eab700;">Cookie</span>, <span style="color: #eab700;">ToPid</span>, <span style="color: #eab700;">TraceToken</span>}           <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">SEND_TT</span>
{16, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">Cookie</span>, <span style="color: #eab700;">ToName</span>, <span style="color: #eab700;">TraceToken</span>} <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">REG_SEND_TT</span>
{18, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToPid</span>, <span style="color: #eab700;">TraceToken</span>, <span style="color: #eab700;">Reason</span>}  <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">EXIT2_TT</span>
{19, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToProc</span>, <span style="color: #eab700;">Ref</span>}                <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">MONITOR_P</span>
{20, <span style="color: #eab700;">FromPid</span>, <span style="color: #eab700;">ToProc</span>, <span style="color: #eab700;">Ref</span>}                <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">DEMONITOR_P</span>
{21, <span style="color: #eab700;">FromProc</span>, <span style="color: #eab700;">ToPid</span>, <span style="color: #eab700;">Ref</span>, <span style="color: #eab700;">Reason</span>}        <span style="color: #8e908c; font-style: italic;">%% </span><span style="color: #8e908c; font-style: italic;">MONITOR_P_EXIT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-97" class="outline-2">
<h2 id="sec-97">Here's how the self process is handling them</h2>
<div class="outline-text-2" id="text-97">
<p>
Full Function: <a href="https://github.com/joedevivo/erlang-haskell-interface/blob/master/src/Foreign/Erlang/Processes.hs#L81-L174">Processes.hs</a>
</p>

<p>
I left a bunch of clauses off this slide
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">self</span>                <span style="color: #eab700;">::</span> <span style="color: #4271ae;">String</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">MVar</span> <span style="color: #4271ae;">ErlMessage</span> <span style="color: #eab700;">-&gt;</span> <span style="color: #4271ae;">IO</span> <span style="color: #4271ae;">()</span>
<span style="color: #f5871f;">self</span> nodename inbox <span style="color: #eab700;">=</span> loop 1 <span style="color: #4271ae;">[]</span> <span style="color: #4271ae;">[]</span> <span style="color: #4271ae;">[]</span>
  <span style="color: #718c00;">where</span>
    loop id registered mboxes nodes <span style="color: #eab700;">=</span> <span style="color: #718c00;">do</span>
        msg <span style="color: #eab700;">&lt;-</span> takeMVar inbox
        debugM <span style="color: #3e999f;">"Foreign.Erlang.Processes"</span>
            <span style="color: #eab700;">$</span> <span style="color: #3e999f;">"loop msg recv'd: "</span> <span style="color: #eab700;">++</span> (show msg)
        <span style="color: #718c00;">case</span> msg <span style="color: #718c00;">of</span>
          <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">other cases omited for clarity</span>
          <span style="color: #4271ae;">ErlDispatch</span> ctl msg <span style="color: #eab700;">-&gt;</span> <span style="color: #718c00;">do</span>
            <span style="color: #718c00;">case</span> ctl <span style="color: #718c00;">of</span>
              <span style="color: #4271ae;">ErlTuple</span> [<span style="color: #4271ae;">ErlInt</span> 2, <span style="color: #718c00;">_</span>, pid] <span style="color: #eab700;">-&gt;</span>
                maybe (return <span style="color: #4271ae;">()</span>) (<span style="color: #eab700;">$</span> msg) <span style="color: #eab700;">$</span> lookup pid mboxes
              <span style="color: #4271ae;">ErlTuple</span> [<span style="color: #4271ae;">ErlInt</span> 6, from, <span style="color: #718c00;">_</span>, pid] <span style="color: #eab700;">-&gt;</span>
                maybe (return <span style="color: #4271ae;">()</span>)
                   (<span style="color: #eab700;">$</span> (<span style="color: #4271ae;">ErlTuple</span> [from, msg])) <span style="color: #eab700;">$</span> lookup pid registered
              <span style="color: #718c00;">_</span> <span style="color: #eab700;">-&gt;</span> return <span style="color: #4271ae;">()</span>
            loop id registered mboxes nodes
          <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">This clause is for when Erlang has connected to this node</span>
          <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">we're just telling this node to add it to the connected nodes.</span>
          <span style="color: #4271ae;">ConnectedNode</span> to node <span style="color: #eab700;">-&gt;</span> <span style="color: #718c00;">do</span>
            <span style="color: #718c00;">case</span> lookup to nodes <span style="color: #718c00;">of</span>
                <span style="color: #4271ae;">Just</span> n <span style="color: #eab700;">-&gt;</span>
                  loop id registered mboxes nodes
                <span style="color: #4271ae;">Nothing</span> <span style="color: #eab700;">-&gt;</span>
                  loop id registered mboxes ((to, node)<span style="color: #4271ae;">:</span>nodes)
          <span style="color: #4271ae;">ErlStop</span> <span style="color: #eab700;">-&gt;</span> return <span style="color: #4271ae;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-98" class="outline-2">
<h2 id="sec-98">net_kernel</h2>
<div class="outline-text-2" id="text-98">
<p>
<a href="https://github.com/joedevivo/erlang-haskell-interface/blob/master/src/Foreign/Erlang/Processes.hs#L264-L277">net_kernel mbox</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">This is the loop that receives erlang messages to the net_kernel</span>
<span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">module. Without it, you can't ping this node</span>
<span style="color: #f5871f;">net_kernel</span> mbox <span style="color: #eab700;">=</span> <span style="color: #718c00;">do</span>
    (<span style="color: #4271ae;">ErlTuple</span> [
        from<span style="color: #eab700;">@</span>(<span style="color: #4271ae;">ErlPid</span> (<span style="color: #4271ae;">ErlAtom</span> node) a b c),
        msg<span style="color: #eab700;">@</span>(<span style="color: #4271ae;">ErlTuple</span> [<span style="color: #718c00;">_</span>,<span style="color: #4271ae;">ErlTuple</span> [<span style="color: #718c00;">_</span>,ref],<span style="color: #718c00;">_</span>])
        ]) <span style="color: #eab700;">&lt;-</span> mboxRecv mbox
    mboxSend mbox node (<span style="color: #4271ae;">Left</span> from) <span style="color: #eab700;">$</span> <span style="color: #4271ae;">ErlTuple</span> [ref, <span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"yes"</span>]
    net_kernel mbox
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-99" class="outline-2">
<h2 id="sec-99">An rpc:call received by Haskell</h2>
<div class="outline-text-2" id="text-99">
<div class="org-src-container">

<pre class="src src-erlang">erlang: <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'haskell@127.0.0.1'</span>, <span style="color: #3e999f;">'mod'</span>, <span style="color: #3e999f;">'fun'</span>, [<span style="color: #3e999f;">'args'</span>]).
</pre>
</div>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #4271ae;">ErlPid</span> (<span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"erlang@127.0.0.1"</span>) 38 0 2
<span style="color: #4271ae;">ErlTuple</span> [<span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"$gen_call"</span>,
          <span style="color: #4271ae;">ErlTuple</span> [<span style="color: #4271ae;">ErlPid</span> (<span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"erlang@127.0.0.1"</span>) 38 0 2,
                    <span style="color: #4271ae;">ErlNewRef</span> (<span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"erlang@127.0.0.1"</span>) 2 [0,0,0,191,0,0,0,0,<span style="color: #c82829; background-color: #d6d6d6;">0,0,0,0]],</span>
          <span style="color: #4271ae;">ErlTuple</span> [<span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"call"</span>,
                    <span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"mod"</span>,
                    <span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"fun"</span>,
                    <span style="color: #4271ae;">ErlList</span> [<span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"args"</span>],
                    <span style="color: #4271ae;">ErlPid</span> (<span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"erlang@127.0.0.1"</span>) 31 0 2]]
</pre>
</div>

<p>
This should look familiar!
</p>
</div>
</div>

<div id="outline-container-sec-100" class="outline-2">
<h2 id="sec-100">The Rex mbox handler</h2>
<div class="outline-text-2" id="text-100">
<p>
<a href="https://github.com/joedevivo/erlang-haskell-interface/blob/master/Test.hs#L32-L60">Test.hs:rex mbox</a>
</p>

<div class="org-src-container">

<pre class="src src-haskell"><span style="color: #f5871f;">rex</span> nodename mbox <span style="color: #eab700;">=</span> <span style="color: #718c00;">do</span>
    (<span style="color: #4271ae;">ErlTuple</span> [
        from<span style="color: #eab700;">@</span>(<span style="color: #4271ae;">ErlPid</span> (<span style="color: #4271ae;">ErlAtom</span> node) a b c),
        msg<span style="color: #eab700;">@</span>(<span style="color: #4271ae;">ErlTuple</span> [<span style="color: #718c00;">_</span>,<span style="color: #4271ae;">ErlTuple</span> [<span style="color: #718c00;">_</span>,ref],<span style="color: #4271ae;">ErlTuple</span> [
                call,
                <span style="color: #4271ae;">ErlAtom</span> modName,
                <span style="color: #4271ae;">ErlAtom</span> funName,
                args,
                <span style="color: #718c00;">_</span> <span style="color: #8e908c; font-style: italic;">-- </span><span style="color: #8e908c; font-style: italic;">GroupLeader</span>
            ])
        ]) <span style="color: #eab700;">&lt;-</span> mboxRecv mbox
    debugM <span style="color: #3e999f;">"Test"</span> <span style="color: #eab700;">$</span> <span style="color: #3e999f;">"rpc "</span> <span style="color: #eab700;">++</span> modName <span style="color: #eab700;">++</span> <span style="color: #3e999f;">":"</span> <span style="color: #eab700;">++</span> funName <span style="color: #eab700;">++</span> <span style="color: #3e999f;">"("</span> <span style="color: #eab700;">++</span> (show args) <span style="color: #eab700;">++</span><span style="color: #c82829; background-color: #d6d6d6;"> </span><span style="color: #c82829; background-color: #d6d6d6;">")"</span>
    <span style="color: #718c00;">case</span> (modName, funName, args) <span style="color: #718c00;">of</span>
      (<span style="color: #3e999f;">"erlang"</span>, <span style="color: #3e999f;">"node"</span>, <span style="color: #4271ae;">ErlNull</span>) <span style="color: #eab700;">-&gt;</span>
        mboxSend mbox node (<span style="color: #4271ae;">Left</span> from) <span style="color: #eab700;">$</span>
            <span style="color: #4271ae;">ErlTuple</span> [ref, <span style="color: #4271ae;">ErlAtom</span> (nodename <span style="color: #eab700;">++</span> <span style="color: #3e999f;">"@127.0.0.1"</span>) ]
      otherwise <span style="color: #eab700;">-&gt;</span>
        mboxSend mbox node (<span style="color: #4271ae;">Left</span> from) <span style="color: #eab700;">$</span>
            <span style="color: #4271ae;">ErlTuple</span> [ref, <span style="color: #4271ae;">ErlAtom</span> <span style="color: #3e999f;">"haskell_equals_very_yes"</span>]
    rex nodename mbox
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-101" class="outline-2">
<h2 id="sec-101">Future Work</h2>
<div class="outline-text-2" id="text-101">
<p>
Notice I'm just returning 'haskell_equals_very_yes' for
everything. I'm just excited that's working since it's my
first stab at Haskell. Plenty of future work here.
</p>
</div>
</div>

<div id="outline-container-sec-102" class="outline-2">
<h2 id="sec-102">gen_haskell?</h2>
<div class="outline-text-2" id="text-102">
<p>
<a href="https://github.com/joedevivo/gen_haskell">VERY YES!</a>
</p>

<ul class="org-ul">
<li>Use port commands to start GHC instead of java!
</li>

<li>Catch the output
</li>

<li>Mostly cut and paste from gen_java
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-103" class="outline-2">
<h2 id="sec-103">It works!</h2>
<div class="outline-text-2" id="text-103">
<p>
<a href="https://github.com/joedevivo/rpc_test">RPC Test app</a>
</p>

<div class="org-src-container">

<pre class="src src-erlang">&#10140; rpc_test ./<span style="color: #eab700;">_rel</span>/rpc_test/bin/rpc_test console
<span style="color: #eab700;">Exec</span>: /<span style="color: #eab700;">Users</span>/joe/dev/joedevivo/rpc_test/<span style="color: #eab700;">_rel</span>/rpc_test/erts-5.10.3/bin/erlexec -boot /<span style="color: #eab700;">Users</span>/joe/dev/joedevivo/rpc_test/<span style="color: #eab700;">_rel</span>/rpc_test/<span style="color: #4271ae;">releases/0</span>.0.1/rpc_test -env <span style="color: #eab700;">ERL_LIBS</span> /<span style="color: #eab700;">Users</span>/joe/dev/joedevivo/rpc_test/<span style="color: #eab700;">_rel</span>/rpc_test/<span style="color: #4271ae;">releases/0</span>.0.1/lib -config /<span style="color: #eab700;">Users</span>/joe/dev/joedevivo/rpc_test/<span style="color: #eab700;">_rel</span>/rpc_test/<span style="color: #4271ae;">releases/0</span>.0.1/sys.config -args_file /<span style="color: #eab700;">Users</span>/joe/dev/joedevivo/rpc_test/<span style="color: #eab700;">_rel</span>/rpc_test/<span style="color: #4271ae;">releases/0</span>.0.1/vm.args -- console
<span style="color: #eab700;">Root</span>: /<span style="color: #eab700;">Users</span>/joe/dev/joedevivo/rpc_test/<span style="color: #eab700;">_rel</span>/rpc_test
/<span style="color: #eab700;">Users</span>/joe/dev/joedevivo/rpc_test/<span style="color: #eab700;">_rel</span>/rpc_test
<span style="color: #eab700;">Erlang</span> <span style="color: #eab700;">R16B02</span> (erts-5.10.3) [source] [64-bit] [smp:8:8] [async-threads:10] [hipe] [kernel-poll:false]

15:33:17.970 [info] <span style="color: #eab700;">Application</span> lager started on node <span style="color: #3e999f;">'rpc_test@127.0.0.1'</span>
15:33:17.970 [info] <span style="color: #eab700;">Application</span> gen_java started on node <span style="color: #3e999f;">'rpc_test@127.0.0.1'</span>
15:33:17.970 [info] <span style="color: #eab700;">Application</span> gen_haskell started on node <span style="color: #3e999f;">'rpc_test@127.0.0.1'</span>
15:33:17.973 [info] [gen_java][my_java] <span style="color: #4271ae;">starting</span> (pid: &lt;0.89.0&gt;)
15:33:17.975 [info] [gen_java][my_java] cmd: <span style="color: #3e999f;">"java -server -cp priv/gen_java.jar com.devivo.gen_java.ErlangServer gen_java_my_java_rpc_test@127.0.0.1 RVDTHTVOBAMGCPHVSWZW 10"</span>
15:33:17.981 [info] [gen_java][my_java] startup: <span style="color: #3e999f;">"7399"</span>
15:33:18.066 [info] [gen_java][my_java] startup: <span style="color: #3e999f;">"Starting OTP Node 'gen_java_my_java_rpc_test@127.0.0.1' with cookie RVDTHTVOBAMGCPHVSWZW"</span>
15:33:18.099 [info] [gen_java][my_java] startup: <span style="color: #3e999f;">"Started node: gen_java_my_java_rpc_test@127.0.0.1"</span>
15:33:18.099 [info] [gen_java][my_java] <span style="color: #eab700;">OS</span> <span style="color: #eab700;">Pid</span>: <span style="color: #3e999f;">"7399"</span>
15:33:18.119 [info] [gen_java][my_java] <span style="color: #eab700;">Thread</span> <span style="color: #eab700;">Pool</span> <span style="color: #eab700;">Size</span> : 10
15:33:18.123 [info] [gen_hasekll][my_haskell] <span style="color: #4271ae;">starting</span> (pid: &lt;0.95.0&gt;)
15:33:18.123 [info] [gen_haskell][my_haskell] cmd: <span style="color: #3e999f;">"runghc Node gen_haskell_my_haskell_rpc_test"</span>
15:33:18.128 [info] [gen_haskell][my_haskell] startup: <span style="color: #3e999f;">"7402"</span>
15:33:18.600 [info] [gen_haskell][my_haskell] startup: <span style="color: #3e999f;">"Starting Node: gen_haskell_my_haskell_rpc_test"</span>
15:33:18.600 [info] [gen_haskell][my_haskell] startup: <span style="color: #3e999f;">"mbox: MBox ErlPid (ErlAtom \"gen_haskell_my_haskell_rpc_test\") 1 0 1 MVar *self*"</span>
15:33:18.600 [info] [gen_haskell][my_haskell] <span style="color: #eab700;">OS</span> <span style="color: #eab700;">Pid</span>: <span style="color: #3e999f;">"7402"</span>
15:33:18.601 [info] [gen_haskell][my_haskell] <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'gen_haskell_my_haskell_rpc_test@127.0.0.1'</span>, erlang, node, []) = {badrpc,nodedown}
15:33:19.606 [info] [gen_haskell][my_haskell] <span style="color: #4271ae;">rpc</span>:<span style="color: #4271ae;">call</span>(<span style="color: #3e999f;">'gen_haskell_my_haskell_rpc_test@127.0.0.1'</span>, erlang, node, []) = <span style="color: #3e999f;">'gen_haskell_my_haskell_rpc_test@127.0.0.1'</span>
15:33:19.607 [info] [gen_haskell][my_haskell] rpc <span style="color: #8959a8;">erlang</span>:<span style="color: #8959a8;">node</span>(<span style="color: #eab700;">ErlNull</span>)
15:33:19.607 [info] [gen_haskell][my_haskell] rpc <span style="color: #8959a8;">erlang</span>:<span style="color: #8959a8;">link</span>(<span style="color: #eab700;">ErlList</span> [<span style="color: #eab700;">ErlPid</span> (<span style="color: #eab700;">ErlAtom</span> <span style="color: #3e999f;">"rpc_test@127.0.0.1"</span>) 95 0 3])
15:33:19.607 [info] <span style="color: #eab700;">Application</span> rpc_test started on node <span style="color: #3e999f;">'rpc_test@127.0.0.1'</span>
<span style="color: #eab700;">Eshell</span> <span style="color: #eab700;">V5</span>.10.3  (abort with ^<span style="color: #eab700;">G</span>)
(rpc_test@127.0.0.1)1&gt; <span style="color: #4271ae;">my_java</span>:<span style="color: #4271ae;">call</span>(erlang, node, []).
<span style="color: #3e999f;">'gen_java_my_java_rpc_test@127.0.0.1'</span>
(rpc_test@127.0.0.1)2&gt; <span style="color: #4271ae;">my_haskell</span>:<span style="color: #4271ae;">call</span>(erlang, node, []).
<span style="color: #3e999f;">'gen_haskell_my_haskell_rpc_test@127.0.0.1'</span>
15:33:39.509 [info] [gen_haskell][my_haskell] rpc <span style="color: #8959a8;">erlang</span>:<span style="color: #8959a8;">node</span>(<span style="color: #eab700;">ErlNull</span>)
(rpc_test@127.0.0.1)3&gt; <span style="color: #4271ae;">my_haskell</span>:<span style="color: #4271ae;">call</span>(erlang, node, [1]).
haskell_equals_very_yes
15:33:46.656 [info] [gen_haskell][my_haskell] rpc <span style="color: #8959a8;">erlang</span>:<span style="color: #8959a8;">node</span>(<span style="color: #eab700;">ErlString</span> <span style="color: #3e999f;">"\SOH"</span>)
(rpc_test@127.0.0.1)4&gt; <span style="color: #4271ae;">my_java</span>:<span style="color: #4271ae;">call</span>(erlang, node, [1]).
{error,<span style="color: #3e999f;">"java.lang.ClassCastException: com.ericsson.otp.erlang.OtpErlangString cannot be cast to com.ericsson.otp.erlang.OtpErlangList"</span>}
(rpc_test@127.0.0.1)5&gt; <span style="color: #4271ae;">q</span>().
ok
15:33:57.068 [info] [gen_haskell][my_haskell] <span style="color: #eab700;">Sending</span> `rex ! stop` from terminate
(rpc_test@127.0.0.1)6&gt; 15:33:57.074 [info] [gen_java][my_java] <span style="color: #eab700;">Sending</span> `rex ! stop` from terminate
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-104" class="outline-2">
<h2 id="sec-104">Fin</h2>
<div class="outline-text-2" id="text-104">

<div class="figure">
<p><img src="./img/erlang-haskell.gif" alt="erlang-haskell.gif" width="800" />
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Joe DeVivo</p>
<p class="date">Created: 2015-04-03 Fri 09:15</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.4.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
